<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>マイページ | レトロこみちイベント</title>
<style>
  :root{
    --bg:#f7fbff;
    --card:#ffffff;
    --muted:#6b7280;
    --accent:#4aa3d9; /* main flat blue */
    --accent-2:#7ad7b8; /* flat green */
    --danger:#e75656;
    --soft:#eef6fb;
    --radius:12px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family: "Hiragino Kaku Gothic ProN","Yu Gothic",system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#24303a}
  .wrap{max-width:1000px;margin:28px auto;padding:20px}
  header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(180deg,var(--accent),#6fb7dd);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:20px}
  h1{font-size:1.2rem;margin:0}
  .controls{display:flex;gap:10px;align-items:center}
  button{background:var(--soft);border:0;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
  .btn-primary{background:linear-gradient(180deg,var(--accent),#3b93c8);color:white}
  .btn-danger{background:linear-gradient(180deg,var(--danger),#d94a4a);color:white}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
  .card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 6px 18px rgba(20,40,60,0.04)}
  .section-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .fav-list{display:flex;flex-direction:column;gap:10px}
  .fav-item{display:flex;gap:12px;align-items:flex-start;padding:10px;border-radius:12px;border:1px solid #eef4f9}
  .thumb{width:96px;height:64px;border-radius:8px;background:#ddd;flex:0 0 96px;object-fit:cover}
  .meta{flex:1}
  .meta h3{margin:0;font-size:1rem}
  .meta .sub{color:var(--muted);font-size:13px;margin-top:6px}
  .actions{display:flex;gap:8px;margin-top:8px}
  .tiny{font-size:13px;color:var(--muted)}
  .row{display:flex;gap:10px;align-items:center}
  .mini-tl{margin-top:12px}
  .timeline-list{display:flex;flex-direction:column;gap:8px}
  .tl-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:10px;background:linear-gradient(180deg,#ffffff,#fbfeff);border:1px solid #eef7fb}
  .alert{padding:8px;border-radius:10px;background:linear-gradient(180deg,#fff6f6,#fff2f2);color:var(--danger);border:1px solid #ffd6d6}
  .chart-wrap{display:flex;align-items:center;gap:12px}
  canvas{max-width:100%}
  .badge-shelf{display:flex;gap:10px;flex-wrap:wrap}
  .badge{width:72px;height:72px;border-radius:10px;background:#f4fbff;display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:700;color:var(--muted);border:1px dashed #e6f3fb}
  .badge.locked{opacity:0.36}
  .share-area{display:flex;gap:8px;flex-direction:column}
  .input{padding:8px;border-radius:8px;border:1px solid #e6eef5;background:#fbfeff}
  .memo-box{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef5;background:#fbfeff}
  .small{font-size:13px;color:var(--muted)}
  footer{margin-top:20px;text-align:center;color:var(--muted);font-size:13px}
  /* sheet style (reuse similar to timetable) */
  .sheet{position:fixed;left:0;right:0;bottom:-520px;background:#fff;border-radius:18px 18px 0 0;padding:16px;box-shadow:0 -8px 40px rgba(0,0,0,0.12);transition:bottom .28s;max-height:86vh;overflow:auto;z-index:800}
  .sheet.open{bottom:0}
  .handle{width:56px;height:6px;background:#ddd;border-radius:6px;margin:8px auto}
  .flexcol{display:flex;flex-direction:column}
  .muted{color:var(--muted)}
  .qr{width:124px;height:124px;border-radius:8px;background:#fff;border:1px solid #e6eef5;display:block}
  .pill{padding:6px 8px;border-radius:999px;background:#f1fbff;border:1px solid #e6f3fb;font-size:12px;color:#256}
  .right{margin-left:auto}
  .danger-link{color:var(--danger);cursor:pointer;text-decoration:underline}
  @media(max-width:980px){
    .grid{grid-template-columns:1fr; padding-bottom:160px}
    .controls{flex-wrap:wrap}
    .card{padding:12px}
  }
  
  /* ============================================================
   あなたのフッター（完全コピー）＋ MyPage強調
============================================================ */
.bottom-nav {
    position:fixed; 
    bottom:10px; 
    left:50%; 
    transform:translateX(-50%); 
    width:92%; 
    background:linear-gradient(135deg, #ffecd2, #fcb69f); 
    border-radius:40px; 
    box-shadow:0 4px 14px rgba(0,0,0,0.15); 
    padding:10px 0; 
    display:flex; 
    justify-content:space-around; 
    font-size:0.95rem;
    z-index:999;
    touch-action:manipulation;
}
.bottom-nav a {
    text-align:center; 
    text-decoration:none; 
    color:#4a3d2f;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:4px;
    padding:8px 6px;
    border-radius:12px;
    min-width:54px;
    min-height:44px; /* タップ領域確保 */
}

/*** ★ MyPage強調 ★ ***/
.bottom-nav a.active {
    color:#000;
    font-weight:700;
    transform:scale(1.06);
}
.bottom-nav a.active img {
    filter:brightness(0.2);
}
  
nav a:hover {
  transform: scale(1.05); /* 少し拡大 */
  color: #fff; /* 文字色を明るく */
  text-shadow: 0 0 6px rgba(255,255,255,0.7); /* 柔らかい光 */
}

nav a:hover img {
  transform: scale(1.15); /* アイコン拡大 */
  filter: brightness(1) saturate(1.6); /* アイコンを明るく・彩度UP */
}

/* modal */
.modal-backdrop{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:1000}
.modal{background:white;border-radius:12px;padding:18px;max-width:720px;width:94%;box-shadow:0 8px 36px rgba(0,0,0,0.2)}
.preview-banner{background:linear-gradient(90deg,#fff7ea,#fff3d8);padding:8px;border-radius:8px;border:1px solid #ffe9bf;margin-bottom:10px}

/* confetti */
#confetti { position: fixed; left: 0; top: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; z-index:1500; display:none; }
.confetti-piece {
  position: absolute;
  width: 8px;
  height: 12px;
  opacity: 0.95;
  will-change: transform, opacity;
  border-radius:2px;
}
@keyframes confetti-fall {
  0% { transform: translate3d(0,-10vh,0) rotate(0deg); opacity:1; }
  100% { transform: translate3d(0,110vh,0) rotate(360deg); opacity:0; }
}

/* exchange button */
.exchange-area { margin-top:12px; display:flex; gap:8px; align-items:center; }
.exchange-area button { min-width:160px; }
.success-note { background: linear-gradient(90deg,#eafff4,#e8fff8); padding:8px;border-radius:8px;border:1px solid #dff7ef;margin-top:10px; }

/* small staff button at edge */
.staff-btn {
  position: fixed;
  right: 12px;
  bottom: 92px; /* above bottom-nav */
  z-index: 1200;
  background: #fff;
  border-radius: 999px;
  padding: 8px 12px;
  box-shadow: 0 6px 18px rgba(20,40,60,0.12);
  cursor: pointer;
  font-weight:700;
  color: var(--accent);
  border: 1px solid #e6eef5;
}
.staff-btn.small { padding:6px 10px; font-size:13px; }

/* staff panel form styles */
.staff-panel-row{ display:flex; gap:8px; align-items:center; margin-top:8px; }
.staff-panel-row input[type="number"]{ width:120px; }
.staff-panel-note{ font-size:13px; color:var(--muted); margin-top:8px; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo">RC</div>
      <div>
        <h1 id="pageTitle">マイページ — レトロこみちイベント</h1>
        <div class="small muted" id="greeting">お気に入りを集めて、ポイントをためよう</div>
      </div>
    </div>

    <div class="controls">
      <div class="small muted" id="pointSummary">ポイント: 0pt</div>
      <button id="btnUnfav" title="すべてのお気に入りを外す">一括お気に入り解除</button>
      <button id="btnResetAll" class="btn-danger" title="ローカルデータを全て消去">リセット（全）</button>
    </div>
  </header>

  <div class="grid">
    <!-- main column -->
    <div>
      <div class="card">
        <div class="section-title">
          <strong>お気に入り一覧</strong>
          <div class="tiny">保存したお気に入りを管理できます</div>
        </div>

        <div id="favList" class="fav-list">
          <!-- favorite items injected here -->
        </div>

        <div style="margin-top:12px" class="small muted">
          <label><input type="checkbox" id="autoOpenShared" /> シェアリンクを開いた際、自動で該当イベント詳細を開く（設定を保存）</label>
        </div>

      </div>

      <div class="card mini-tl" style="margin-top:14px;">
        <div class="section-title">
          <strong>ミニタイムライン（お気に入り）</strong>
          <div class="tiny">お気に入りだけを時間順に表示します</div>
        </div>

        <div id="overlapAlert" style="display:none" class="alert"></div>

        <div id="timelineMini" class="timeline-list">
          <!-- timeline rows -->
        </div>
      </div>

      <div class="card" style="margin-top:14px;">
        <div class="section-title">
          <strong>シェア / QR</strong>
          <div class="tiny">友達にお気に入りやポイントを簡単共有</div>
        </div>

        <div class="share-area">
          <div class="row" style="align-items:center;">
            <input id="shareUrl" class="input" readonly style="flex:1"/>
            <button id="copyShare" class="btn-primary">コピー</button>
          </div>

          <div class="row" style="margin-top:8px;">
            <button id="genText" class="">共有用テキスト生成</button>
            <button id="genQr" >QR を表示</button>
            <button id="openShare" >リンクを新しいタブで開く</button>
          </div>

          <div style="display:flex;gap:12px;margin-top:8px;align-items:center">
            <img id="qrImg" class="qr" src="" alt="QR" style="display:none"/>
            <textarea id="shareText" class="input" rows="4" placeholder="シェア用テキストがここに出ます"></textarea>
          </div>
        </div>
      </div>

    </div>

    <!-- right column -->
    <aside>
      <div class="card">
        <div class="section-title"><strong>ポイント進捗</strong><div class="tiny">目標: 200pt</div></div>
        <div style="display:flex;align-items:center;gap:14px;flex-direction:column">
          <div style="width:140px;height:140px;display:flex;align-items:center;justify-content:center">
            <canvas id="pointsChart" width="140" height="140"></canvas>
          </div>
          <div style="width:100%;text-align:center">
            <div id="pointsText" style="font-size:1.2rem;font-weight:700">0 / 200 pt</div>
            <div class="small muted" id="earnedText">獲得: 0pt ・ 消費: 0pt</div>
            <div class="small muted" id="rankText">称号: -</div>
            <div style="margin-top:8px" class="small muted">行ったイベント数: <span id="doneCount">0</span></div>

            <!-- Exchange area under the chart -->
            <div class="exchange-area">
              <button id="btnExchange" class="btn-primary" disabled>ポイントを景品と交換する</button>
              <div class="small muted" id="availText" style="margin-left:auto">残高: 0pt</div>
            </div>
            <div id="exchangeNote" class="small muted" style="margin-top:8px">※ 100ポイント以上で交換できます</div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <div class="section-title"><strong>あなたのバッジ</strong><div class="tiny">ポイントで自動的に付与されます</div></div>
        <div id="badgeShelf" class="badge-shelf">
          <!-- badges injected -->
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <div class="section-title"><strong>設定・データ</strong><div class="tiny">メモやお気に入りを管理</div></div>
        <div class="small muted">お気に入り数: <span id="favCount">0</span></div>
        <div style="margin-top:8px" class="row">
          <button id="btnClearFavs">お気に入りのみリセット</button>
          <button id="btnClearMemo">メモを全部消す</button>
        </div>

        <hr style="margin:12px 0">
        <div class="small muted" style="margin-bottom:6px">マイページ表示名</div>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="myNameInput" class="input" placeholder="例: うまる" />
          <button id="saveNameBtn" class="btn-primary">保存</button>
          <button id="clearNameBtn">クリア</button>
        </div>
        <div class="small muted" style="margin-top:8px">保存された表示名: <span id="currentName">—</span></div>

        <hr style="margin:12px 0">
        <div class="small muted">交換履歴</div>
        <div id="redemptionList" style="margin-top:8px"></div>

        <hr style="margin:12px 0">
        <div class="small muted">付与（管理）履歴</div>
        <div id="adminList" style="margin-top:8px"></div>

      </div>
    </aside>
  </div>
  
  <nav class="bottom-nav">
  
  <a href="map.html">
    <img src="map.svg" style="width:17px;">Map
  </a>
  <a href="timetable.html">
    <img src="time.svg" style="width:17px;">Timetable
  </a>
  <a href="search.html">
    <img src="search.svg" style="width:17px;">Search
  </a>

  <!-- ★ 今いるページ：MyPage 強調 ★ -->
  <a href="mypage.html" class="active">
    <img src="user.svg" style="width:17px;">
    My Page
  </a>

  <a href="list.html">
    <img src="list.svg" style="width:17px;">List
  </a>
</nav>

  <footer>
    <div>© レトロこみちイベント</div>
  </footer>
</div>

<!-- detail sheet (reused) -->
<div id="sheet" class="sheet" aria-hidden="true">
  <div class="handle"></div>
  <div id="sheetContent" style="padding-bottom:40px"></div>
</div>

<!-- modal for share accept -->
<div id="shareAcceptModal" style="display:none"></div>

<!-- exchange modal (larger) -->
<div id="exchangeModal" style="display:none"></div>

<!-- confetti container -->
<div id="confetti" aria-hidden="true"></div>

<!-- small staff button -->
<button id="staffBtn" class="staff-btn small" title="関係者はこちら">関係者はこちら</button>

<script>
/*
  mypage.html — スタッフ付与/消費機能追加版
  - localStorage keys:
    fav_ids, done_ids, memo_<id>, my_name, auto_open_shared
    redemptions: [{id,title,cost,date}]
    admin_adjustments: [{id,amount,note,date}]
    confetti_50_shown: "1" flag
  - Points:
    - done event: 10pt
    - favorite: 5pt
    - admin adjustments (positive adds to earned)
    - available = earned + admin_adjustments - spent
  - Staff flow:
    - staffBtn opens staff-auth modal
    - correct STAFF_CODE opens staff panel where staff can:
      - 付与: 指定ポイント数を付与（admin_adjustments に記録）
      - 消費: 任意の消費を登録（redemptions に記録）
*/

let events = [
  {id:101,title:'オープニングトーク',start:'10:00',end:'10:30',place:'メインホール',description:'イベントのはじまりの挨拶です。',details:'出演者: AAA\n持ち物: 特に無し',image:'https://picsum.photos/seed/101/400/240',category:'トーク'},
  {id:102,title:'ワークショップA',start:'11:00',end:'12:00',place:'Room A',description:'クリエイティブなワークショップ',details:'対象: 初心者歓迎\n注意: 汚れてもOKな服装',image:'https://picsum.photos/seed/102/400/240',category:'ワークショップ'},
  {id:103,title:'昭和写真トーク',start:'12:30',end:'13:30',place:'ギャラリー',description:'昭和の写真についてのトークショー',details:'ゲスト: 鈴木太郎',image:'https://picsum.photos/seed/103/400/240',category:'トーク'},
  {id:104,title:'音楽ライブ',start:'14:00',end:'15:00',place:'ステージ前',description:'レトロバンドのライブ',details:'演奏: レトロBAND',image:'https://picsum.photos/seed/104/400/240',category:'ライブ'},
  {id:105,title:'展示解説',start:'15:30',end:'16:00',place:'展示室',description:'展示の見どころを紹介',details:'解説: 学芸員',image:'https://picsum.photos/seed/105/400/240',category:'展示'},
];

// config
const POINT_PER_EVENT = 10;
const POINT_PER_FAV = 5;
const POINT_GOAL = 200;

const EXCHANGE_COST = 100;          // 交換に必要なポイント
const STAFF_CODE = 'EVENT2025';     // 関係者コード（必要なら変更）

const $ = id => document.getElementById(id);
const favListEl = $('favList');
const timelineEl = $('timelineMini');
const pointSummaryEl = $('pointSummary');
const pointsCanvas = $('pointsChart');
const pointsText = $('pointsText');
const earnedText = $('earnedText');
const rankText = $('rankText');
const doneCountEl = $('doneCount');
const badgeShelf = $('badgeShelf');
const favCountEl = $('favCount');
const overlapAlertEl = $('overlapAlert');
const shareUrlEl = $('shareUrl');
const qrImgEl = $('qrImg');
const shareTextEl = $('shareText');
const modalEl = $('shareAcceptModal');
const myNameInput = $('myNameInput');
const saveNameBtn = $('saveNameBtn');
const clearNameBtn = $('clearNameBtn');
const currentNameEl = $('currentName');
const confettiEl = $('confetti');
const btnExchange = $('btnExchange');
const availText = $('availText');
const redemptionListEl = $('redemptionList');
const adminListEl = $('adminList');
const staffBtn = $('staffBtn');

function getLocalArr(key){ try{ return JSON.parse(localStorage.getItem(key)||'[]'); }catch(e){ return []; } }
function setLocalArr(key,arr){ localStorage.setItem(key, JSON.stringify(arr)); }

// redemptions storage
function getRedemptions(){ try{ return JSON.parse(localStorage.getItem('redemptions')||'[]'); }catch(e){ return []; } }
function setRedemptions(arr){ localStorage.setItem('redemptions', JSON.stringify(arr)); }
function addRedemption(rec){ const arr = getRedemptions(); arr.push(rec); setRedemptions(arr); }

// admin adjustments storage (付与/管理操作)
function getAdminAdjustments(){ try{ return JSON.parse(localStorage.getItem('admin_adjustments')||'[]'); }catch(e){ return []; } }
function setAdminAdjustments(arr){ localStorage.setItem('admin_adjustments', JSON.stringify(arr)); }
function addAdminAdjustment(rec){ const arr = getAdminAdjustments(); arr.push(rec); setAdminAdjustments(arr); }

// favorites / done
let favIds = getLocalArr('fav_ids');
let doneIds = getLocalArr('done_ids');

// preview mode when opening someone else's shared link
let previewMode = false;
let previewFavIds = [];
let previewDoneIds = [];
let previewSharer = '';

// autoOpenShared persisted
let autoOpenShared = (localStorage.getItem('auto_open_shared') !== '0'); // default true

// load name
let myName = localStorage.getItem('my_name') || '';
function updateNameUI(){
  currentNameEl.textContent = myName || '—';
  myNameInput.value = myName || '';
  const greeting = myName ? `こんにちは、${myName}さん` : 'お気に入りを集めて、ポイントをためよう';
  $('greeting').textContent = greeting;
}
updateNameUI();

// Points calculations
function computeEarnedPoints(){ 
  const favBonus = Array.isArray(favIds) ? favIds.length * POINT_PER_FAV : 0;
  const doneBonus = Array.isArray(doneIds) ? doneIds.length * POINT_PER_EVENT : 0;
  const adminSum = getAdminAdjustments().reduce((s,x)=> s + (Number(x.amount)||0), 0);
  return favBonus + doneBonus + adminSum;
}
function getSpentPoints(){ return getRedemptions().reduce((s,r)=> s + (r.cost||0), 0); }
function computeAvailablePoints(){ return computeEarnedPoints() - getSpentPoints(); }

// convenience old name
function computePoints(){ return computeAvailablePoints(); }

let prevPoints = computePoints();

// UI rendering
function renderAll(){
  renderFavList();
  renderMiniTimeline();
  renderPoints();
  renderBadges();
  renderRedemptions();
  renderAdminAdjustments();
  favCountEl.textContent = favIds.length;
  // update share url
  shareUrlEl.value = genShareUrl();
}

function renderFavList(){
  favListEl.innerHTML = '';
  const usingIds = previewMode ? previewFavIds : favIds;
  if(!usingIds || usingIds.length===0){
    favListEl.innerHTML = `<div class="tiny muted">${previewMode ? '共有されたお気に入りはありません' : 'お気に入りに入れたイベントはここに表示されます。'}</div>`;
    return;
  }
  const favEvents = events.filter(e=>usingIds.includes(e.id));
  favEvents.forEach(ev=>{
    const div = document.createElement('div');
    div.className='fav-item';
    div.innerHTML = `
      <img class="thumb" src="${ev.image||'https://picsum.photos/seed/placeholder/400/240'}" alt="${ev.title}">
      <div class="meta">
        <h3>${ev.title}</h3>
        <div class="sub">${ev.start} - ${ev.end} ・ ${ev.place} ・ <span class="pill">${ev.category||'その他'}</span></div>
        <div class="actions">
          <button class="openBtn">詳細</button>
          ${ previewMode ? '' : `<button class="btnFavToggle">${isFav(ev.id)?'お気に入り済':'お気に入り'}</button>` }
          <label style="display:inline-flex;align-items:center;gap:6px"><input type="checkbox" class="doneChk" ${isDone(ev.id)?'checked':''} ${previewMode ? 'disabled' : ''}> 行った</label>
          <button class="memoBtn">メモ</button>
        </div>
        <div style="margin-top:8px"><div class="small muted">メモ:</div><div id="memo_${ev.id}" class="small" style="min-height:18px">${getMemo(ev.id)||'<span class=muted>（メモなし）</span>'}</div></div>
      </div>
    `;
    favListEl.appendChild(div);

    div.querySelector('.openBtn').addEventListener('click',()=> openSheet(ev));
    if(!previewMode){
      div.querySelector('.btnFavToggle').addEventListener('click',()=>{
        toggleFav(ev.id);
        renderAll();
      });
      div.querySelector('.doneChk').addEventListener('change',(e)=>{
        toggleDone(ev.id,e.target.checked);
        renderAll();
      });
    }
    div.querySelector('.memoBtn').addEventListener('click',()=>{
      openMemoPrompt(ev);
    });
  });
}

function renderMiniTimeline(){
  timelineEl.innerHTML='';
  const usingIds = previewMode ? previewFavIds : favIds;
  if(!usingIds || usingIds.length===0){ timelineEl.innerHTML='<div class="muted small">お気に入りがありません</div>'; overlapAlertEl.style.display='none'; return; }
  const favEvents = events.filter(e=>usingIds.includes(e.id)).sort((a,b)=> timeToMinutes(a.start)-timeToMinutes(b.start));
  favEvents.forEach(ev=>{
    const row = document.createElement('div');
    row.className='tl-row';
    row.innerHTML = `<div><strong>${ev.start}</strong> ${ev.title}</div><div class="row"><div class="small muted">${ev.place}</div><div style="width:12px"></div><button class="openBtn">詳細</button></div>`;
    timelineEl.appendChild(row);
    row.querySelector('.openBtn').addEventListener('click',()=> openSheet(ev));
  });

  // overlap check
  const overlaps = findOverlaps(favEvents);
  if(overlaps.length){
    overlapAlertEl.style.display='block';
    overlapAlertEl.innerHTML = `⚠ 以下の時間が重なっています：<br>${overlaps.map(pair=>`${pair[0].title}（${pair[0].start}-${pair[0].end}） と ${pair[1].title}（${pair[1].start}-${pair[1].end}）`).join('<br>')}`;
  } else {
    overlapAlertEl.style.display='none';
  }
}

function findOverlaps(list){
  const out = [];
  for(let i=0;i<list.length;i++){
    for(let j=i+1;j<list.length;j++){
      if(isOverlap(list[i].start,list[i].end,list[j].start,list[j].end)){
        out.push([list[i],list[j]]);
      }
    }
  }
  return out;
}
function isOverlap(s1,e1,s2,e2){
  const a = timeToMinutes(s1), b = timeToMinutes(e1), c = timeToMinutes(s2), d = timeToMinutes(e2);
  return Math.max(a,c) < Math.min(b,d);
}
function timeToMinutes(t){ const [hh,mm] = t.split(':').map(Number); return hh*60+mm; }

function openSheet(ev){
  const details = ev.details ? ev.details.replace(/\n/g,'<br>') : '';
  const memo = getMemo(ev.id);
  const favBtnText = isFav(ev.id)?'お気に入り解除':'お気に入りに追加';
  const doneChk = isDone(ev.id) ? 'checked' : '';
  $('sheetContent').innerHTML = `
    <div style="display:flex;gap:12px">
      <img src="${ev.image||'https://picsum.photos/seed/placeholder/400/240'}" style="width:160px;height:96px;object-fit:cover;border-radius:8px">
      <div style="flex:1">
        <h2 style="margin:0 0 6px 0">${ev.title}</h2>
        <div class="small muted">${ev.start} - ${ev.end} ・ ${ev.place} ・ <span class="pill">${ev.category||'その他'}</span></div>
        <p style="margin-top:8px">${ev.description||''}</p>
        <div style="margin-top:6px" class="small muted">詳細:</div>
        <div class="tiny" style="margin-top:6px">${details}</div>
        <div style="margin-top:10px" class="row">
          ${ previewMode ? '' : `<button id="sheetFavBtn">${favBtnText}</button>` }
          <label style="display:inline-flex;align-items:center;gap:6px"><input id="sheetDone" type="checkbox" ${doneChk} ${previewMode ? 'disabled' : ''}> 行った</label>
          <button id="sheetShare">共有</button>
        </div>
        <div style="margin-top:8px">
          <div class="small muted">メモ</div>
          <textarea id="sheetMemo" class="memo-box" rows="3">${memo||''}</textarea>
          <div style="margin-top:8px" class="row">
            <button id="saveMemoBtn" class="btn-primary">保存</button>
            <button id="closeSheet" style="margin-left:auto">閉じる</button>
          </div>
        </div>
      </div>
    </div>
  `;
  $('sheet').classList.add('open'); $('sheet').setAttribute('aria-hidden','false');

  if(!previewMode){
    $('sheetFavBtn').addEventListener('click',()=>{
      toggleFav(ev.id);
      renderAll();
      openSheet(ev); // refresh sheet
    });
    $('sheetDone').addEventListener('change',(e)=>{
      toggleDone(ev.id,e.target.checked);
      renderAll();
    });
  }
  $('saveMemoBtn').addEventListener('click',()=>{
    const txt = $('sheetMemo').value.trim();
    saveMemo(ev.id,txt);
    renderAll();
    alert('メモを保存しました');
  });
  $('closeSheet').addEventListener('click',()=>{
    $('sheet').classList.remove('open'); $('sheet').setAttribute('aria-hidden','true');
  });
  $('sheetShare').addEventListener('click',()=>{
    const url = genShareUrl();
    copyTextToClipboard(url);
    alert('共有リンクをコピーしました');
  });
}

$('sheet').addEventListener('click', e => { if(e.target === $('sheet')){ $('sheet').classList.remove('open'); $('sheet').setAttribute('aria-hidden','true'); } });

// favorites toggle
function isFav(id){ return favIds.includes(id); }
function toggleFav(id){
  if(isFav(id)){
    favIds = favIds.filter(x=>x!==id);
  } else {
    favIds.push(id);
  }
  setLocalArr('fav_ids',favIds);
  renderAll();
}
function isDone(id){ return doneIds.includes(id); }
function toggleDone(id,checked){
  if(checked){
    if(!doneIds.includes(id)) doneIds.push(id);
  } else {
    doneIds = doneIds.filter(x=>x!==id);
  }
  setLocalArr('done_ids',doneIds);
}

// memos
function saveMemo(id,txt){ localStorage.setItem('memo_'+id,txt); }
function getMemo(id){ return localStorage.getItem('memo_'+id) || ''; }
function openMemoPrompt(ev){
  const prev = getMemo(ev.id);
  const s = prompt(`「${ev.title}」のメモを入力してください（空欄で削除）`,prev||'');
  if(s===null) return;
  const trimmed = s.trim();
  if(trimmed) saveMemo(ev.id,trimmed);
  else localStorage.removeItem('memo_'+ev.id);
  renderAll();
}

// sharing
function genShareUrl(){
  const base = location.origin + location.pathname;
  const fav = (previewMode ? previewFavIds.join(',') : favIds.join(','));
  const done = (previewMode ? previewDoneIds.join(',') : doneIds.join(','));
  const name = localStorage.getItem('my_name') || '';
  const parts = [];
  if(fav) parts.push('fav='+encodeURIComponent(fav));
  if(done) parts.push('done='+encodeURIComponent(done));
  if(name) parts.push('sharer='+encodeURIComponent(name));
  parts.push('auto=' + (autoOpenShared ? '1' : '0'));
  return base + (parts.length ? ('?'+parts.join('&')) : '');
}
function copyTextToClipboard(text){
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(text).catch(()=>{ fallbackCopy(text); });
  } else {
    fallbackCopy(text);
  }
  function fallbackCopy(t){
    const ta=document.createElement('textarea');
    ta.value=t; ta.style.position='fixed'; ta.style.left='-9999px';
    document.body.appendChild(ta); ta.select();
    try{ document.execCommand('copy'); }catch(e){}
    document.body.removeChild(ta);
  }
}

// share controls
$('copyShare').addEventListener('click',()=>{
  const url = genShareUrl();
  copyTextToClipboard(url);
  alert('共有リンクをコピーしました');
});
$('openShare').addEventListener('click',()=>{
  const url = genShareUrl();
  window.open(url,'_blank');
});
$('genText').addEventListener('click', ()=>{
  const txt = buildShareText();
  shareTextEl.value = txt;
  copyTextToClipboard(txt);
  alert('共有テキストを生成＆コピーしました（貼り付けて共有できます）');
});
$('genQr').addEventListener('click', ()=>{
  const url = genShareUrl();
  const qrUrl = 'https://chart.googleapis.com/chart?cht=qr&chs=300x300&chl=' + encodeURIComponent(url);
  qrImgEl.src = qrUrl;
  qrImgEl.style.display = 'block';
});

// build share text
function buildShareText(){
  const earned = computeEarnedPoints();
  const avail = computeAvailablePoints();
  const favEvents = events.filter(e=>favIds.includes(e.id));
  const doneEvents = events.filter(e=>doneIds.includes(e.id));
  const lines = [];
  const name = localStorage.getItem('my_name') || '';
  lines.push((name ? name + ' さんの ' : '私の ') + 'レトロこみちポイント（利用可能）： ' + avail + 'pt（獲得: ' + earned + 'pt）');
  lines.push('');
  if(doneEvents.length){
    lines.push('行ったイベント:');
    doneEvents.forEach(e=> lines.push(`・${e.title}（${e.start}）`));
    lines.push('');
  }
  if(favEvents.length){
    lines.push('お気に入り:');
    favEvents.forEach(e=> lines.push(`・${e.title}（${e.start}）`));
    lines.push('');
  }
  lines.push('お気に入りを開く：' + genShareUrl());
  return lines.join('\n');
}

// points & chart + confetti handling
function renderPoints(){
  const earned = computeEarnedPoints();
  const spent = getSpentPoints();
  const avail = computeAvailablePoints();
  pointSummaryEl.textContent = `ポイント: ${avail}pt`;
  pointsText.textContent = `${avail} / ${POINT_GOAL} pt`;
  earnedText.textContent = `獲得: ${earned}pt ・ 消費: ${spent}pt`;
  doneCountEl.textContent = doneIds.length;

  // rank text (simple thresholds on earned)
  const rank = earned >= 200 ? 'レトロこみち王' : earned >= 100 ? 'レトロマスター' : earned >= 50 ? '初級レトロウォーカー' : 'ビギナー';
  rankText.textContent = '称号: ' + rank;

  // draw donut chart on canvas (available/goal)
  const canvas = pointsCanvas;
  const ctx = canvas.getContext('2d');
  const size = Math.min(canvas.width, canvas.height);
  const cx = canvas.width/2, cy = canvas.height/2, r = size/2 - 6;
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // background circle (goal)
  ctx.beginPath();
  ctx.arc(cx,cy,r,0,Math.PI*2);
  ctx.fillStyle = '#f3fbff';
  ctx.fill();

  const ratio = Math.min(1, Math.max(0, avail / POINT_GOAL));
  const start = -Math.PI/2;
  const end = start + ratio * Math.PI*2;

  // filled arc (accent color)
  ctx.beginPath();
  ctx.moveTo(cx,cy);
  ctx.arc(cx,cy,r,start,end);
  ctx.closePath();
  ctx.fillStyle = 'rgba(74,163,217,0.95)';
  ctx.fill();

  // cut center to make donut
  ctx.beginPath();
  ctx.arc(cx,cy,r*0.62,0,Math.PI*2);
  ctx.fillStyle = '#ffffff';
  ctx.fill();

  // text in center
  ctx.fillStyle = '#24303a';
  ctx.font = '700 14px system-ui,Segoe UI';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(Math.round(ratio*100) + '%', cx, cy-6);
  ctx.font = '600 11px system-ui';
  ctx.fillText(avail + 'pt', cx, cy+14);

  // confetti trigger for 50 points (based on available)
  try {
    const shown = localStorage.getItem('confetti_50_shown') === '1';
    if(avail >= 50 && !shown){
      launchConfetti();
      localStorage.setItem('confetti_50_shown','1');
    } else if(avail < 50 && shown){
      // reset so next time can show again
      localStorage.removeItem('confetti_50_shown');
    }
  } catch(e){ console.warn(e); }

  // enable/disable exchange button
  if(!previewMode && avail >= EXCHANGE_COST){
    btnExchange.removeAttribute('disabled');
  } else {
    btnExchange.setAttribute('disabled','disabled');
  }

  // update small avail text
  availText.textContent = `残高: ${avail}pt`;

  prevPoints = avail;
}

// confetti implementation (vanilla)
function launchConfetti(){
  if(!confettiEl) return;
  confettiEl.style.display = 'block';
  const colors = ['#ff6b6b','#ffd166','#4aa3d9','#7ad7b8','#9b72d1','#ff9aa2'];
  const pieces = 100;
  for(let i=0;i<pieces;i++){
    const el = document.createElement('div');
    el.className = 'confetti-piece';
    const size = Math.floor(6 + Math.random()*10);
    el.style.width = size + 'px';
    el.style.height = Math.floor(size*1.4) + 'px';
    el.style.background = colors[Math.floor(Math.random()*colors.length)];
    el.style.left = Math.random()*100 + '%';
    el.style.top = (-Math.random()*10) + 'vh';
    el.style.transform = `rotate(${Math.floor(Math.random()*360)}deg)`;
    const delay = Math.random() * 0.6;
    const duration = 2.5 + Math.random() * 1.5;
    el.style.animation = `confetti-fall ${duration}s ${delay}s cubic-bezier(.2,.6,.2,1) forwards`;
    confettiEl.appendChild(el);
  }
  // remove after 4.5s
  setTimeout(()=> {
    confettiEl.innerHTML = '';
    confettiEl.style.display = 'none';
  }, 4500);
}

// redemption rendering
function renderRedemptions(){
  const list = getRedemptions();
  if(!list.length){
    redemptionListEl.innerHTML = '<div class="small muted">利用履歴はありません</div>';
  } else {
    redemptionListEl.innerHTML = list.slice().reverse().map(r=>`<div class="small">${new Date(r.date).toLocaleString()} — ${r.title} (${r.cost}pt)</div>`).join('');
  }
}

// admin adjustments rendering
function renderAdminAdjustments(){
  const list = getAdminAdjustments();
  if(!list.length){
    adminListEl.innerHTML = '<div class="small muted">付与履歴はありません</div>';
  } else {
    adminListEl.innerHTML = list.slice().reverse().map(a=>{
      const sign = Number(a.amount) >= 0 ? '+' : '';
      return `<div class="small">${new Date(a.date).toLocaleString()} — ${a.note||'管理操作'}： ${sign}${a.amount}pt</div>`;
    }).join('');
  }
}

// Exchange flow (existing)
btnExchange.addEventListener('click', ()=>{
  if(previewMode) return alert('プレビュー中は交換できません');
  openExchangeModal();
});

function openExchangeModal(){
  const earned = computeEarnedPoints();
  const spent = getSpentPoints();
  const avail = computeAvailablePoints();
  const html = `
    <div class="modal-backdrop">
      <div class="modal">
        <h2>景品交換</h2>
        <div style="display:flex;gap:12px;align-items:center">
          <div style="width:120px;height:120px;display:flex;align-items:center;justify-content:center">
            <canvas id="exchangeChart" width="120" height="120"></canvas>
          </div>
          <div style="flex:1">
            <div style="font-size:1.1rem;font-weight:700">${avail} pt（利用可能）</div>
            <div class="small muted">獲得: ${earned}pt ・ 消費: ${spent}pt</div>
            <div style="margin-top:10px" class="small muted">交換可能: ${avail >= EXCHANGE_COST ? '可能' : '残高不足'}</div>
          </div>
        </div>

        <div style="margin-top:14px">
          <div class="small muted">交換アイテム</div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;border:1px solid #eef4f9;margin-top:8px">
            <div>
              <strong>限定ステッカーセット</strong>
              <div class="small muted">イベント限定デザインのステッカー</div>
            </div>
            <div style="text-align:right">
              <div class="small muted">${EXCHANGE_COST} pt</div>
              <button id="proceedExchange" class="btn-primary" ${avail >= EXCHANGE_COST ? '' : 'disabled'}>交換へ進む</button>
            </div>
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="closeExchange" style="margin-left:auto">閉じる</button>
        </div>
      </div>
    </div>
  `;
  $('exchangeModal').innerHTML = html;
  $('exchangeModal').style.display = 'block';

  // draw small chart inside modal to mirror available/goal
  const exCanvas = document.getElementById('exchangeChart');
  if(exCanvas){
    const ctx = exCanvas.getContext('2d');
    const size = Math.min(exCanvas.width, exCanvas.height);
    const cx = exCanvas.width/2, cy = exCanvas.height/2, r = size/2 - 6;
    ctx.clearRect(0,0,exCanvas.width,exCanvas.height);
    ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fillStyle='#f3fbff'; ctx.fill();
    const ratio = Math.min(1, Math.max(0, computeAvailablePoints()/POINT_GOAL));
    const start = -Math.PI/2;
    const end = start + ratio * Math.PI*2;
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,start,end); ctx.closePath(); ctx.fillStyle='rgba(74,163,217,0.95)'; ctx.fill();
    ctx.beginPath(); ctx.arc(cx,cy,r*0.62,0,Math.PI*2); ctx.fillStyle='#fff'; ctx.fill();
    ctx.fillStyle='#24303a'; ctx.font='700 12px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(Math.round(ratio*100) + '%', cx, cy-6); ctx.font='600 11px system-ui'; ctx.fillText(computeAvailablePoints() + 'pt', cx, cy+14);
  }

  // attach handlers
  $('closeExchange').addEventListener('click', ()=> { $('exchangeModal').style.display='none'; });
  const proceed = document.getElementById('proceedExchange');
  proceed && proceed.addEventListener('click', ()=> {
    // show staff code input area
    showStaffCodeEntry();
  });
}

function showStaffCodeEntry(){
  const html = `
    <div class="modal-backdrop">
      <div class="modal">
        <h2>関係者確認</h2>
        <div class="small muted">関係者の方は下のコードを入力し、「確認」してください。</div>
        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <input id="staffCodeInput" class="input" placeholder="関係者コードを入力" style="flex:1"/>
          <button id="confirmStaffCode" class="btn-primary">確認</button>
        </div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="cancelStaffCode" style="margin-left:auto">キャンセル</button>
        </div>
      </div>
    </div>
  `;
  $('exchangeModal').innerHTML = html;
  $('exchangeModal').style.display = 'block';
  $('cancelStaffCode').addEventListener('click', ()=> { $('exchangeModal').style.display='none'; });

  $('confirmStaffCode').addEventListener('click', ()=> {
    const code = $('staffCodeInput').value.trim();
    if(code === STAFF_CODE){
      // allow staff to finalize exchange — we reuse the exchange modal to complete
      const item = { id: 'ex1', title: '限定ステッカーセット', cost: EXCHANGE_COST, date: new Date().toISOString() };
      addRedemption(item);
      $('exchangeModal').innerHTML = `
        <div class="modal-backdrop">
          <div class="modal">
            <h2>交換完了</h2>
            <div class="success-note">ポイントを消費しました。<br> ${item.title} を ${item.cost}pt 消費しました。</div>
            <div style="display:flex;gap:8px;margin-top:12px">
              <button id="closeSuccess" class="btn-primary">閉じる</button>
            </div>
          </div>
        </div>`;
      $('closeSuccess').addEventListener('click', ()=>{
        $('exchangeModal').style.display = 'none';
        renderAll();
      });
    } else {
      alert('関係者コードが正しくありません');
    }
  });
}

// staff button -> auth -> staff panel
staffBtn.addEventListener('click', ()=> {
  openStaffAuthModal();
});

function openStaffAuthModal(){
  const html = `
    <div class="modal-backdrop">
      <div class="modal">
        <h3>関係者ログイン</h3>
        <div class="small muted">管理者コードを入力してください。</div>
        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <input id="staffAuthInput" class="input" placeholder="関係者コード" style="flex:1"/>
          <button id="staffAuthBtn" class="btn-primary">ログイン</button>
        </div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="staffAuthCancel" style="margin-left:auto">閉じる</button>
        </div>
      </div>
    </div>
  `;
  modalEl.innerHTML = html; modalEl.style.display = 'block';
  $('staffAuthCancel').addEventListener('click', ()=> { modalEl.style.display='none'; });
  $('staffAuthBtn').addEventListener('click', ()=> {
    const code = $('staffAuthInput').value.trim();
    if(code === STAFF_CODE){
      modalEl.style.display = 'none';
      openStaffPanel();
    } else {
      alert('関係者コードが正しくありません');
    }
  });
}

function openStaffPanel(){
  const earned = computeEarnedPoints();
  const spent = getSpentPoints();
  const avail = computeAvailablePoints();
  const html = `
    <div class="modal-backdrop">
      <div class="modal">
        <h2>スタッフパネル</h2>
        <div class="small muted">現在のポイント： 利用可能 ${avail}pt（獲得 ${earned}pt / 消費 ${spent}pt）</div>

        <hr style="margin:10px 0">

        <div><strong>ポイントを付与する</strong></div>
        <div class="staff-panel-row">
          <input id="adminGrantAmount" type="number" min="1" placeholder="付与ポイント" class="input"/>
          <input id="adminGrantNote" placeholder="備考（例: 受付ボーナス）" class="input" />
          <button id="adminGrantBtn" class="btn-primary">付与する</button>
        </div>
        <div class="staff-panel-note">付与は即時アカウントに反映されます。</div>

        <hr style="margin:10px 0">

        <div><strong>ポイントを消費（管理で登録）する</strong></div>
        <div class="staff-panel-row">
          <input id="adminSpendAmount" type="number" min="1" placeholder="消費ポイント" class="input"/>
          <input id="adminSpendNote" placeholder="備考（例: 交換手配）" class="input" />
          <button id="adminSpendBtn" class="btn-primary">消費登録</button>
        </div>
        <div class="staff-panel-note">消費登録は redemptions に追加され、利用可能ポイントが減ります。</div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="closeStaffPanel" style="margin-left:auto">閉じる</button>
        </div>
      </div>
    </div>
  `;
  modalEl.innerHTML = html; modalEl.style.display = 'block';

  $('closeStaffPanel').addEventListener('click', ()=> { modalEl.style.display='none'; renderAll(); });

  $('adminGrantBtn').addEventListener('click', ()=> {
    const amt = Number($('adminGrantAmount').value) || 0;
    const note = $('adminGrantNote').value.trim() || '管理付与';
    if(amt <= 0){ alert('付与ポイントは1以上で入力してください'); return; }
    if(!confirm(`${amt}pt を付与しますか？\n備考: ${note}`)) return;
    const rec = { id: 'g'+Date.now(), amount: amt, note: note, date: new Date().toISOString() };
    addAdminAdjustment(rec);
    alert(`${amt}pt を付与しました`);
    modalEl.style.display = 'none';
    renderAll();
  });

  $('adminSpendBtn').addEventListener('click', ()=> {
    const amt = Number($('adminSpendAmount').value) || 0;
    const note = $('adminSpendNote').value.trim() || '管理消費';
    if(amt <= 0){ alert('消費ポイントは1以上で入力してください'); return; }
    if(computeAvailablePoints() < amt){ alert('残高が不足しています'); return; }
    if(!confirm(`${amt}pt を消費登録しますか？\n備考: ${note}`)) return;
    const rec = { id: 's'+Date.now(), title: note, cost: amt, date: new Date().toISOString() };
    addRedemption(rec);
    alert(`${amt}pt を消費登録しました`);
    modalEl.style.display = 'none';
    renderAll();
  });
}

// badges (simple flat icons)
const BADGE_DEFS = [
  {id:'b1',title:'初級レトロウォーカー',threshold:50},
  {id:'b2',title:'レトロマスター',threshold:100},
  {id:'b3',title:'レトロこみち王',threshold:200},
];
function renderBadges(){
  badgeShelf.innerHTML='';
  const earned = computeEarnedPoints();
  BADGE_DEFS.forEach(b=>{
    const el = document.createElement('div');
    el.className = 'badge ' + (earned >= b.threshold ? '' : 'locked');
    el.innerHTML = `<div style="font-size:12px">${b.title}</div><div class="small muted" style="margin-top:6px">${b.threshold}pt</div>`;
    badgeShelf.appendChild(el);
  });
}

// bulk actions
$('btnUnfav').addEventListener('click', ()=>{
  if(!confirm('本当にすべてのお気に入りを解除しますか？')) return;
  favIds = [];
  setLocalArr('fav_ids',favIds);
  renderAll();
});
$('btnResetAll').addEventListener('click', ()=>{
  if(!confirm('ローカルデータ（お気に入り・行った・メモ 等）をすべて消去しますか？戻せません。')) return;
  localStorage.clear();
  favIds = []; doneIds = [];
  myName = '';
  updateNameUI();
  renderAll();
});
$('btnClearFavs').addEventListener('click', ()=>{
  if(!confirm('お気に入りだけをリセットします。よろしいですか？')) return;
  favIds = []; setLocalArr('fav_ids',favIds); renderAll();
});
$('btnClearMemo').addEventListener('click', ()=>{
  if(!confirm('メモをすべて削除します。よろしいですか？')) return;
  for(const k in localStorage) if(k.startsWith('memo_')) localStorage.removeItem(k);
  renderAll();
});

// helper to build fav/done arrays on load if none exist
if(!Array.isArray(favIds)) favIds = [];
if(!Array.isArray(doneIds)) doneIds = [];

// save name
saveNameBtn.addEventListener('click', ()=>{
  const v = myNameInput.value.trim();
  myName = v;
  if(myName) localStorage.setItem('my_name', myName);
  else localStorage.removeItem('my_name');
  updateNameUI();
  shareUrlEl.value = genShareUrl();
  alert('表示名を保存しました');
});
clearNameBtn.addEventListener('click', ()=>{
  if(!confirm('表示名をクリアしますか？')) return;
  myName = '';
  localStorage.removeItem('my_name');
  updateNameUI();
  shareUrlEl.value = genShareUrl();
});

// auto open shared persist
$('autoOpenShared').checked = autoOpenShared;
$('autoOpenShared').addEventListener('change', (e)=> {
  autoOpenShared = !!e.target.checked;
  localStorage.setItem('auto_open_shared', autoOpenShared ? '1' : '0');
});

// when URL loads with fav/done and sharer, show accept dialog (unchanged)
function showShareAcceptDialog(sharer, favList, doneList){
  const modalHtml = `
    <div class="modal-backdrop">
      <div class="modal">
        <h3>${sharer} さんから共有リンクを受け取りました</h3>
        <p class="small muted">以下のお気に入りを一時的にプレビューできます。あなたのローカルデータは変更されません。プレビューを受け入れると共有者のお気に入り一覧を確認できます。必要なら後で自分のお気に入りに取り込みできます。</p>
        <div style="margin-top:8px;max-height:220px;overflow:auto;border:1px solid #f0f4f8;padding:8px;border-radius:8px;">
          ${ (favList.length ? favList.map(id=>{
              const ev = events.find(e=>e.id===id);
              return `<div style="margin-bottom:6px"><strong>${ev?ev.title:'(不明なイベント)'} </strong><div class="small muted">${ev?ev.start+' ・ '+ev.place:''}</div></div>`;
            }).join('') : '<div class="muted small">共有されたお気に入りはありません</div>') }
        </div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="acceptSharedBtn" class="btn-primary">プレビューを開く</button>
          <button id="importSharedBtn">自分のお気に入りに取り込む</button>
          <button id="declineSharedBtn" style="margin-left:auto">閉じる</button>
        </div>
      </div>
    </div>
  `;
  modalEl.innerHTML = modalHtml;
  modalEl.style.display = 'block';

  $('acceptSharedBtn').addEventListener('click', ()=>{
    // set preview mode and render
    previewMode = true;
    previewFavIds = favList.slice();
    previewDoneIds = doneList.slice();
    previewSharer = sharer;
    modalEl.style.display = 'none';
    renderAll();
    showPreviewBanner();
  });
  $('importSharedBtn').addEventListener('click', ()=>{
    // merge into favIds and doneIds
    const mergedFav = Array.from(new Set([...(favIds||[]), ...favList]));
    const mergedDone = Array.from(new Set([...(doneIds||[]), ...doneList]));
    favIds = mergedFav; doneIds = mergedDone;
    setLocalArr('fav_ids',favIds);
    setLocalArr('done_ids',doneIds);
    modalEl.style.display = 'none';
    previewMode = false;
    previewFavIds = []; previewDoneIds = [];
    alert('共有されたお気に入りをあなたのマイページに取り込みました');
    renderAll();
  });
  $('declineSharedBtn').addEventListener('click', ()=>{
    modalEl.style.display = 'none';
  });
}

function showPreviewBanner(){
  // show a temporary banner area above favList to indicate preview mode
  const parentCard = favListEl.parentElement;
  let banner = parentCard.querySelector('.preview-banner');
  if(!banner){
    banner = document.createElement('div');
    banner.className = 'preview-banner';
    parentCard.insertBefore(banner, favListEl);
  }
  banner.innerHTML = `<strong>プレビュー中：</strong> ${previewSharer || '共有者'} さんの共有お気に入り。<span class="small muted">（あなたのローカルは変更されていません）</span>
    <div style="margin-top:8px;display:flex;gap:8px">
      <button id="importFromPreview" class="btn-primary">自分のお気に入りに取り込む</button>
      <button id="exitPreview" style="margin-left:auto">プレビューを閉じる</button>
    </div>`;
  parentCard.scrollIntoView({behavior:'smooth'});

  $('importFromPreview').addEventListener('click', ()=>{
    const merged = Array.from(new Set([...(favIds||[]), ...previewFavIds]));
    favIds = merged;
    setLocalArr('fav_ids',favIds);
    previewMode = false;
    previewFavIds = [];
    alert('プレビューのお気に入りをあなたのマイページに取り込みました');
    renderAll();
  });
  $('exitPreview').addEventListener('click', ()=>{
    previewMode = false;
    previewFavIds = [];
    if(banner) banner.remove();
    renderAll();
  });
}

// parse params and decide whether to show modal automatically
(function(){
  const params = new URLSearchParams(location.search);
  const favParam = params.get('fav');
  const doneParam = params.get('done');
  const sharer = params.get('sharer');
  const auto = params.get('auto');
  if(auto==='0') autoOpenShared = false;
  $('autoOpenShared').checked = autoOpenShared;

  if(sharer && (favParam || doneParam)){
    const favList = favParam ? favParam.split(',').map(s=>Number(s)).filter(Boolean) : [];
    const doneList = doneParam ? doneParam.split(',').map(s=>Number(s)).filter(Boolean) : [];
    if(autoOpenShared){
      // show modal automatically
      setTimeout(()=> showShareAcceptDialog(sharer, favList, doneList), 300);
    } else {
      // still show modal but user may opt out
      setTimeout(()=> { showShareAcceptDialog(sharer, favList, doneList); }, 300);
    }
  } else {
    // if URL has ev param and autoOpenShared true, open that event sheet (existing behavior)
    const evId = Number(params.get('ev'));
    if(evId && autoOpenShared){
      const ev = events.find(x=>x.id===evId);
      if(ev) setTimeout(()=> openSheet(ev), 300);
    }
  }
})();

// build share text and set url initially
shareUrlEl.value = genShareUrl();

// UI init
window.addEventListener('DOMContentLoaded', ()=>{
  renderAll();
});

// expose for debug
window._mp = {
  events, favIds, doneIds, getRedemptions, getAdminAdjustments
};

</script>
</body>
</html>
