<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>マイページ | レトロこみちイベント</title>
<style>
  :root{
    --bg:#f7fbff;
    --card:#ffffff;
    --muted:#6b7280;
    --accent:#4aa3d9;
    --accent-2:#7ad7b8;
    --danger:#e75656;
    --soft:#eef6fb;
    --radius:12px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family: "Hiragino Kaku Gothic ProN","Yu Gothic",system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#24303a}
  .wrap{max-width:1000px;margin:28px auto;padding:20px}
  header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(180deg,var(--accent),#6fb7dd);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:20px}
  h1{font-size:1.2rem;margin:0}
  .controls{display:flex;gap:10px;align-items:center}
  button{background:var(--soft);border:0;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
  .btn-primary{background:linear-gradient(180deg,var(--accent),#3b93c8);color:white}
  .btn-danger{background:linear-gradient(180deg,var(--danger),#d94a4a);color:white}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
  .card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 6px 18px rgba(20,40,60,0.04)}
  .section-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .fav-list{display:flex;flex-direction:column;gap:10px}
  .fav-item{display:flex;gap:12px;align-items:flex-start;padding:10px;border-radius:12px;border:1px solid #eef4f9}
  .thumb{width:96px;height:64px;border-radius:8px;background:#ddd;flex:0 0 96px;object-fit:cover}
  .meta{flex:1}
  .meta h3{margin:0;font-size:1rem}
  .meta .sub{color:var(--muted);font-size:13px;margin-top:6px}
  .actions{display:flex;gap:8px;margin-top:8px}
  .tiny{font-size:13px;color:var(--muted)}
  .row{display:flex;gap:10px;align-items:center}
  .mini-tl{margin-top:12px}
  .timeline-list{display:flex;flex-direction:column;gap:8px}
  .tl-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:10px;background:linear-gradient(180deg,#ffffff,#fbfeff);border:1px solid #eef7fb}
  .alert{padding:8px;border-radius:10px;background:linear-gradient(180deg,#fff6f6,#fff2f2);color:var(--danger);border:1px solid #ffd6d6}
  .chart-wrap{display:flex;align-items:center;gap:12px}
  canvas{max-width:100%}
  .badge-shelf{display:flex;gap:10px;flex-wrap:wrap}
  .badge{width:72px;height:72px;border-radius:10px;background:#f4fbff;display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:700;color:var(--muted);border:1px dashed #e6f3fb}
  .badge.locked{opacity:0.36}
  .share-area{display:flex;gap:8px;flex-direction:column}
  .input{padding:8px;border-radius:8px;border:1px solid #e6eef5;background:#fbfeff}
  .memo-box{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef5;background:#fbfeff}
  .small{font-size:13px;color:var(--muted)}
  footer{margin-top:20px;text-align:center;color:var(--muted);font-size:13px}
  .sheet{position:fixed;left:0;right:0;bottom:-520px;background:#fff;border-radius:18px 18px 0 0;padding:16px;box-shadow:0 -8px 40px rgba(0,0,0,0.12);transition:bottom .28s;max-height:86vh;overflow:auto;z-index:800}
  .sheet.open{bottom:0}
  .handle{width:56px;height:6px;background:#ddd;border-radius:6px;margin:8px auto}
  .flexcol{display:flex;flex-direction:column}
  .muted{color:var(--muted)}
  .qr{width:124px;height:124px;border-radius:8px;background:#fff;border:1px solid #e6eef5;display:block}
  .pill{padding:6px 8px;border-radius:999px;background:#f1fbff;border:1px solid #e6f3fb;font-size:12px;color:#256}
  .right{margin-left:auto}
  .danger-link{color:var(--danger);cursor:pointer;text-decoration:underline}
  @media(max-width:980px){
    .grid{grid-template-columns:1fr; padding-bottom:160px}
    .controls{flex-wrap:wrap}
    .card{padding:12px}
  }
  .bottom-nav { position:fixed; bottom:10px; left:50%; transform:translateX(-50%); width:92%; background:linear-gradient(135deg, #ffecd2, #fcb69f); border-radius:40px; box-shadow:0 4px 14px rgba(0,0,0,0.15); padding:10px 0; display:flex; justify-content:space-around; font-size:0.95rem; z-index:999; touch-action:manipulation; }
  .bottom-nav a { text-align:center; text-decoration:none; color:#4a3d2f; display:flex; flex-direction:column; align-items:center; gap:4px; padding:8px 6px; border-radius:12px; min-width:54px; min-height:44px; }
  .bottom-nav a.active { color:#000; font-weight:700; transform:scale(1.06); }
  .modal-backdrop{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:1000}
  .modal{background:white;border-radius:12px;padding:18px;max-width:720px;width:94%;box-shadow:0 8px 36px rgba(0,0,0,0.2)}
  .preview-banner{background:linear-gradient(90deg,#fff7ea,#fff3d8);padding:8px;border-radius:8px;border:1px solid #ffe9bf;margin-bottom:10px}
  #confetti { position: fixed; left: 0; top: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; z-index:1500; display:none; }
  .confetti-piece { position: absolute; width: 8px; height: 12px; opacity: 0.95; will-change: transform, opacity; border-radius:2px; }
  @keyframes confetti-fall { 0% { transform: translate3d(0,-10vh,0) rotate(0deg); opacity:1; } 100% { transform: translate3d(0,110vh,0) rotate(360deg); opacity:0; } }
  .exchange-area { margin-top:12px; display:flex; gap:8px; align-items:center; }
  .staff-btn { position: fixed; right: 12px; bottom: 92px; z-index: 1200; background: #fff; border-radius: 999px; padding: 8px 12px; box-shadow: 0 6px 18px rgba(20,40,60,0.12); cursor: pointer; font-weight:700; color: var(--accent); border: 1px solid #e6eef5; }
  .qr-scanner { width:100%; max-width:720px; padding:12px; display:flex;flex-direction:column; gap:10px; }
  .qr-video { width:100%; background:#000; border-radius:8px; overflow:hidden; position:relative; } 
  .qr-video video { width:100%; height:auto; display:block; }
  .qr-manual { display:flex; gap:8px; }
  .qr-result { font-weight:700; margin-top:8px; }
  .staff-panel-row{ display:flex; gap:8px; align-items:center; margin-top:8px; }
  .staff-panel-row input[type="number"]{ width:120px; }
  .staff-panel-note{ font-size:13px; color:var(--muted); margin-top:8px; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo">RC</div>
      <div>
        <h1 id="pageTitle">マイページ — レトロこみちイベント</h1>
        <div class="small muted" id="greeting">お気に入りを集めて、ポイントをためよう</div>
      </div>
    </div>

    <div class="controls">
      <div class="small muted" id="pointSummary">ポイント: 0pt</div>
      <button id="btnUnfav" title="すべてのお気に入りを外す">一括お気に入り解除</button>
      <button id="btnResetAll" class="btn-danger" title="ローカルデータを全て消去">リセット（全）</button>
    </div>
  </header>

  <div class="grid">
    <!-- main column -->
    <div>
      <div class="card">
        <div class="section-title">
          <strong>お気に入り一覧</strong>
          <div class="tiny">保存したお気に入りを管理できます</div>
        </div>

        <div id="favList" class="fav-list">
          <!-- favorite items injected here -->
        </div>

        <div style="margin-top:12px" class="small muted">
          <label><input type="checkbox" id="autoOpenShared" /> シェアリンクを開いた際、自動で該当イベント詳細を開く（設定を保存）</label>
        </div>

      </div>

      <div class="card mini-tl" style="margin-top:14px;">
        <div class="section-title">
          <strong>ミニタイムライン（お気に入り）</strong>
          <div class="tiny">お気に入りだけを時間順に表示します</div>
        </div>

        <div id="overlapAlert" style="display:none" class="alert"></div>

        <div id="timelineMini" class="timeline-list">
          <!-- timeline rows -->
        </div>
      </div>

      <div class="card" style="margin-top:14px;">
        <div class="section-title">
          <strong>シェア / QR</strong>
          <div class="tiny">友達にお気に入りやポイントを簡単共有 / QRで配布できるリンク</div>
        </div>

        <div class="share-area">
          <div class="row" style="align-items:center;">
            <input id="shareUrl" class="input" readonly style="flex:1"/>
            <button id="copyShare" class="btn-primary">コピー</button>
          </div>

          <div class="row" style="margin-top:8px;">
            <button id="genText" class="">共有用テキスト生成</button>
            <button id="genQr" >QR を表示</button>
            <button id="openShare" >リンクを新しいタブで開く</button>
             <buton id="btnScanQr"></buton>
          </div>

          <div style="display:flex;gap:12px;margin-top:8px;align-items:center">
            <img id="qrImg" class="qr" src="" alt="QR" style="display:none"/>
            <textarea id="shareText" class="input" rows="4" placeholder="シェア用テキストがここに出ます"></textarea>
          </div>
        </div>
      </div>

    </div>

    <!-- right column -->
    <aside>
      <div class="card">
        <div class="section-title"><strong>ポイント進捗</strong><div class="tiny">目標: 200pt</div></div>
        <div style="display:flex;align-items:center;gap:14px;flex-direction:column">
          <div style="width:140px;height:140px;display:flex;align-items:center;justify-content:center">
            <canvas id="pointsChart" width="140" height="140"></canvas>
          </div>
          <div style="width:100%;text-align:center">
            <div id="pointsText" style="font-size:1.2rem;font-weight:700">0 / 200 pt</div>
            <div class="small muted" id="earnedText">獲得: 0pt ・ 消費: 0pt</div>
            <div class="small muted" id="rankText">称号: -</div>
            <div style="margin-top:8px" class="small muted">行ったイベント数: <span id="doneCount">0</span></div>

            <!-- Exchange area under the chart -->
            <div class="exchange-area">
              <button id="btnExchange" class="btn-primary" disabled>ポイントを景品と交換する</button>
              <div class="small muted" id="availText" style="margin-left:auto">残高: 0pt</div>
            </div>
            <div id="exchangeNote" class="small muted" style="margin-top:8px">※ 100ポイント以上で交換できます</div>
          </div>
        </div>
      </div>

     
       
        <div id="badgeShelf" class="badge-shelf">
          <!-- badges injected -->
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <div class="section-title"><strong>設定・データ</strong><div class="tiny">メモやお気に入りを管理</div></div>
        <div class="small muted">お気に入り数: <span id="favCount">0</span></div>
        <div style="margin-top:8px" class="row">
          <button id="btnClearFavs">お気に入りのみリセット</button>
          <button id="btnClearMemo">メモを全部消す</button>
        </div>

        <hr style="margin:12px 0">
        <div class="small muted" style="margin-bottom:6px">マイページ表示名</div>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="myNameInput" class="input" placeholder="例:レトロくん" />
          <button id="saveNameBtn" class="btn-primary">保存</button>
          <button id="clearNameBtn">クリア</button>
        </div>
        <div class="small muted" style="margin-top:8px">保存された表示名: <span id="currentName">—</span></div>

        <hr style="margin:12px 0">
        <div class="small muted">交換履歴</div>
        <div id="redemptionList" style="margin-top:8px"></div>

        <hr style="margin:12px 0">
        <div class="small muted">付与（管理）履歴</div>
        <div id="adminList" style="margin-top:8px"></div>
      </div>
    </aside>
  </div>
  
  <nav class="bottom-nav">
  
  <a href="map.html">
    <img src="map.svg" style="width:17px;">Map
  </a>
  <a href="timetable.html">
    <img src="time.svg" style="width:17px;">Timetable
  </a>
  <a href="search.html">
    <img src="search.svg" style="width:17px;">Search
  </a>

  <!-- ★ 今いるページ：MyPage 強調 ★ -->
  <a href="mypage.html" class="active">
    <img src="user.svg" style="width:17px;">
    My Page
  </a>

  <a href="list.html">
    <img src="list.svg" style="width:17px;">List
  </a>
</nav>

  <footer>
    <div>© レトロこみちイベント</div>
  </footer>
</div>

<!-- detail sheet (reused) -->
<div id="sheet" class="sheet" aria-hidden="true">
  <div class="handle"></div>
  <div id="sheetContent" style="padding-bottom:40px"></div>
</div>

<!-- modal placeholders -->
<div id="shareAcceptModal" style="display:none"></div>
<div id="exchangeModal" style="display:none"></div>
<div id="qrScannerModal" style="display:none"></div>

<!-- confetti container -->
<div id="confetti" aria-hidden="true"></div>

<!-- small staff button -->
<button id="staffBtn" class="staff-btn small" title="関係者はこちら">関係者はこちら</button>

<script>
/*
  Final merged mypage.html
  - Keeps full v4 functionality (staff panel, exchange, confetti, share & preview, badges)
  - Adds claim-link generation (staff can create grant/spend links that can be turned into QR)
  - Supports opening claim links like: ?claim_type=grant&amount=10&token=...&event=101&note=...
  - Keeps optional QR camera scanner for convenience (BarcodeDetector if available)
  - All storage is client-side (localStorage). For robust cross-device enforcement, use server-side.
*/

const POINT_PER_EVENT = 10;
const POINT_PER_FAV = 5;
const POINT_GOAL = 200;
const EXCHANGE_COST = 100;
const STAFF_CODE = 'EVENT2025';

const $ = id => document.getElementById(id);

// storage helpers
function getLocalArr(key){ try{ return JSON.parse(localStorage.getItem(key)||'[]'); }catch(e){ return []; } }
function setLocalArr(key,arr){ localStorage.setItem(key, JSON.stringify(arr)); }

function getRedemptions(){ try{ return JSON.parse(localStorage.getItem('redemptions')||'[]'); }catch(e){ return []; } }
function setRedemptions(arr){ localStorage.setItem('redemptions', JSON.stringify(arr)); }
function addRedemption(rec){ const arr = getRedemptions(); arr.push(rec); setRedemptions(arr); }

function getAdminAdjustments(){ try{ return JSON.parse(localStorage.getItem('admin_adjustments')||'[]'); }catch(e){ return []; } }
function setAdminAdjustments(arr){ localStorage.setItem('admin_adjustments', JSON.stringify(arr)); }
function addAdminAdjustment(rec){ const arr = getAdminAdjustments(); arr.push(rec); setAdminAdjustments(arr); }

// sample events (kept)
let events = [
  {id:101,title:'オープニングトーク',start:'10:00',end:'10:30',place:'メインホール',description:'イベントのはじまりの挨拶です。',details:'出演者: AAA\n持ち物: 特に無し',image:'https://picsum.photos/seed/101/400/240',category:'トーク'},
  {id:102,title:'ワークショップA',start:'11:00',end:'12:00',place:'Room A',description:'クリエイティブなワークショップ',details:'対象: 初心者歓迎\n注意: 汚れてもOKな服装',image:'https://picsum.photos/seed/102/400/240',category:'ワークショップ'},
  {id:103,title:'昭和写真トーク',start:'12:30',end:'13:30',place:'ギャラリー',description:'昭和の写真についてのトークショー',details:'ゲスト: 鈴木太郎',image:'https://picsum.photos/seed/103/400/240',category:'トーク'},
  {id:104,title:'音楽ライブ',start:'14:00',end:'15:00',place:'ステージ前',description:'レトロバンドのライブ',details:'演奏: レトロBAND',image:'https://picsum.photos/seed/104/400/240',category:'ライブ'},
  {id:105,title:'展示解説',start:'15:30',end:'16:00',place:'展示室',description:'展示の見どころを紹介',details:'解説: 学芸員',image:'https://picsum.photos/seed/105/400/240',category:'展示'},
];

// UI refs
const favListEl = $('favList');
const timelineEl = $('timelineMini');
const pointSummaryEl = $('pointSummary');
const pointsCanvas = $('pointsChart');
const pointsText = $('pointsText');
const earnedText = $('earnedText');
const rankText = $('rankText');
const doneCountEl = $('doneCount');
const badgeShelf = $('badgeShelf');
const favCountEl = $('favCount');
const overlapAlertEl = $('overlapAlert');
const shareUrlEl = $('shareUrl');
const qrImgEl = $('qrImg');
const shareTextEl = $('shareText');
const modalEl = $('shareAcceptModal');
const qrScannerModalEl = $('qrScannerModal');
const redemptionListEl = $('redemptionList');
const adminListEl = $('adminList');
const btnExchange = $('btnExchange');
const availText = $('availText');
const staffBtn = $('staffBtn');

// state
let favIds = getLocalArr('fav_ids');
let doneIds = getLocalArr('done_ids');
if(!Array.isArray(favIds)) favIds = [];
if(!Array.isArray(doneIds)) doneIds = [];

let previewMode = false;
let previewFavIds = [];
let previewDoneIds = [];
let previewSharer = '';

let autoOpenShared = (localStorage.getItem('auto_open_shared') !== '0'); // default true
let myName = localStorage.getItem('my_name') || '';

function updateNameUI(){
  $('currentName') && ($('currentName').textContent = myName || '—');
  $('myNameInput') && ($('myNameInput').value = myName || '');
  $('greeting') && ($('greeting').textContent = myName ? `こんにちは、${myName}さん` : 'お気に入りを集めて、ポイントをためよう');
}
updateNameUI();

// Points
function computeEarnedPoints(){
  const favBonus = Array.isArray(favIds) ? favIds.length * POINT_PER_FAV : 0;
  const doneBonus = Array.isArray(doneIds) ? doneIds.length * POINT_PER_EVENT : 0;
  const adminSum = getAdminAdjustments().reduce((s,x)=> s + (Number(x.amount)||0), 0);
  return favBonus + doneBonus + adminSum;
}
function getSpentPoints(){ return getRedemptions().reduce((s,r)=> s + (r.cost||0), 0); }
function computeAvailablePoints(){ return computeEarnedPoints() - getSpentPoints(); }
function computePoints(){ return computeAvailablePoints(); }

// Rendering
function renderAll(){
  renderFavList();
  renderMiniTimeline();
  renderPoints();
  renderBadges();
  renderRedemptions();
  renderAdminAdjustments();
  favCountEl.textContent = favIds.length;
  shareUrlEl.value = genShareUrl();
}

function renderFavList(){
  favListEl.innerHTML = '';
  const usingIds = previewMode ? previewFavIds : favIds;
  if(!usingIds || usingIds.length===0){
    favListEl.innerHTML = `<div class="tiny muted">${previewMode ? '共有されたお気に入りはありません' : 'お気に入りに入れたイベントはここに表示されます。'}</div>`;
    return;
  }
  const favEvents = events.filter(e=>usingIds.includes(e.id));
  favEvents.forEach(ev=>{
    const div = document.createElement('div');
    div.className='fav-item';
    div.innerHTML = `
      <img class="thumb" src="${ev.image||'https://picsum.photos/seed/placeholder/400/240'}" alt="${ev.title}">
      <div class="meta">
        <h3>${ev.title}</h3>
        <div class="sub">${ev.start} - ${ev.end} ・ ${ev.place} ・ <span class="pill">${ev.category||'その他'}</span></div>
        <div class="actions">
          <button class="openBtn">詳細</button>
          ${ previewMode ? '' : `<button class="btnFavToggle">${isFav(ev.id)?'お気に入り済':'お気に入り'}</button>` }
          <label style="display:inline-flex;align-items:center;gap:6px"><input type="checkbox" class="doneChk" ${isDone(ev.id)?'checked':''} ${previewMode ? 'disabled' : ''}> 行った</label>
          <button class="memoBtn">メモ</button>
        </div>
        <div style="margin-top:8px"><div class="small muted">メモ:</div><div id="memo_${ev.id}" class="small" style="min-height:18px">${getMemo(ev.id)||'<span class=muted>（メモなし）</span>'}</div></div>
      </div>
    `;
    favListEl.appendChild(div);

    div.querySelector('.openBtn').addEventListener('click',()=> openSheet(ev));
    if(!previewMode){
      const favBtn = div.querySelector('.btnFavToggle');
      favBtn && favBtn.addEventListener('click',()=>{
        toggleFav(ev.id);
        renderAll();
      });
      const doneChk = div.querySelector('.doneChk');
      doneChk && doneChk.addEventListener('change',(e)=>{
        toggleDone(ev.id,e.target.checked);
        renderAll();
      });
    }
    div.querySelector('.memoBtn').addEventListener('click',()=> openMemoPrompt(ev));
  });
}

function renderMiniTimeline(){
  timelineEl.innerHTML='';
  const usingIds = previewMode ? previewFavIds : favIds;
  if(!usingIds || usingIds.length===0){ timelineEl.innerHTML='<div class="muted small">お気に入りがありません</div>'; overlapAlertEl.style.display='none'; return; }
  const favEvents = events.filter(e=>usingIds.includes(e.id)).sort((a,b)=> timeToMinutes(a.start)-timeToMinutes(b.start));
  favEvents.forEach(ev=>{
    const row = document.createElement('div'); row.className='tl-row';
    row.innerHTML = `<div><strong>${ev.start}</strong> ${ev.title}</div><div class="row"><div class="small muted">${ev.place}</div><div style="width:12px"></div><button class="openBtn">詳細</button></div>`;
    timelineEl.appendChild(row);
    row.querySelector('.openBtn').addEventListener('click',()=> openSheet(ev));
  });

  const overlaps = findOverlaps(favEvents);
  if(overlaps.length){
    overlapAlertEl.style.display='block';
    overlapAlertEl.innerHTML = `⚠ 以下の時間が重なっています：<br>${overlaps.map(pair=>`${pair[0].title}（${pair[0].start}-${pair[0].end}） と ${pair[1].title}（${pair[1].start}-${pair[1].end}）`).join('<br>')}`;
  } else {
    overlapAlertEl.style.display='none';
  }
}
function findOverlaps(list){ const out=[]; for(let i=0;i<list.length;i++){ for(let j=i+1;j<list.length;j++){ if(isOverlap(list[i].start,list[i].end,list[j].start,list[j].end)) out.push([list[i],list[j]]); } } return out; }
function isOverlap(s1,e1,s2,e2){ const a=timeToMinutes(s1),b=timeToMinutes(e1),c=timeToMinutes(s2),d=timeToMinutes(e2); return Math.max(a,c) < Math.min(b,d); }
function timeToMinutes(t){ const [hh,mm] = t.split(':').map(Number); return hh*60+mm; }

function openSheet(ev){
  const details = ev.details ? ev.details.replace(/\n/g,'<br>') : '';
  const memo = getMemo(ev.id);
  const favBtnText = isFav(ev.id)?'お気に入り解除':'お気に入りに追加';
  const doneChk = isDone(ev.id) ? 'checked' : '';
  $('sheetContent').innerHTML = `
    <div style="display:flex;gap:12px">
      <img src="${ev.image||'https://picsum.photos/seed/placeholder/400/240'}" style="width:160px;height:96px;object-fit:cover;border-radius:8px">
      <div style="flex:1">
        <h2 style="margin:0 0 6px 0">${ev.title}</h2>
        <div class="small muted">${ev.start} - ${ev.end} ・ ${ev.place} ・ <span class="pill">${ev.category||'その他'}</span></div>
        <p style="margin-top:8px">${ev.description||''}</p>
        <div style="margin-top:6px" class="small muted">詳細:</div>
        <div class="tiny" style="margin-top:6px">${details}</div>
        <div style="margin-top:10px" class="row">
          ${ previewMode ? '' : `<button id="sheetFavBtn">${favBtnText}</button>` }
          <label style="display:inline-flex;align-items:center;gap:6px"><input id="sheetDone" type="checkbox" ${doneChk} ${previewMode ? 'disabled' : ''}> 行った</label>
          <button id="sheetShare">共有</button>
        </div>
        <div style="margin-top:8px">
          <div class="small muted">メモ</div>
          <textarea id="sheetMemo" class="memo-box" rows="3">${memo||''}</textarea>
          <div style="margin-top:8px" class="row">
            <button id="saveMemoBtn" class="btn-primary">保存</button>
            <button id="closeSheet" style="margin-left:auto">閉じる</button>
          </div>
        </div>
      </div>
    </div>
  `;
  $('sheet').classList.add('open'); $('sheet').setAttribute('aria-hidden','false');

  if(!previewMode){
    const sheetFav = $('sheetFavBtn');
    sheetFav && sheetFav.addEventListener('click',()=>{ toggleFav(ev.id); renderAll(); openSheet(ev); });
    const sheetDone = $('sheetDone');
    sheetDone && sheetDone.addEventListener('change',(e)=>{ toggleDone(ev.id,e.target.checked); renderAll(); });
  }
  $('saveMemoBtn').addEventListener('click',()=>{
    const txt = $('sheetMemo').value.trim();
    saveMemo(ev.id,txt);
    renderAll();
    alert('メモを保存しました');
  });
  $('closeSheet').addEventListener('click',()=>{
    $('sheet').classList.remove('open'); $('sheet').setAttribute('aria-hidden','true');
  });
  $('sheetShare').addEventListener('click',()=>{
    copyTextToClipboard(genShareUrl());
    alert('共有リンクをコピーしました');
  });
}

// favorites, done
function isFav(id){ return favIds.includes(id); }
function toggleFav(id){ if(isFav(id)){ favIds = favIds.filter(x=>x!==id); } else { favIds.push(id); } setLocalArr('fav_ids',favIds); }
function isDone(id){ return doneIds.includes(id); }
function toggleDone(id,checked){ if(checked){ if(!doneIds.includes(id)) doneIds.push(id); } else doneIds = doneIds.filter(x=>x!==id); setLocalArr('done_ids',doneIds); }

// memos
function saveMemo(id,txt){ localStorage.setItem('memo_'+id,txt); }
function getMemo(id){ return localStorage.getItem('memo_'+id) || ''; }
function openMemoPrompt(ev){ const prev=getMemo(ev.id); const s=prompt(`「${ev.title}」のメモを入力してください（空欄で削除）`,prev||''); if(s===null) return; const t=s.trim(); if(t) saveMemo(ev.id,t); else localStorage.removeItem('memo_'+ev.id); renderAll(); }

// sharing
function genShareUrl(){ const base = location.origin + location.pathname; const fav = (previewMode ? previewFavIds.join(',') : favIds.join(',')); const done = (previewMode ? previewDoneIds.join(',') : doneIds.join(',')); const name = localStorage.getItem('my_name') || ''; const parts = []; if(fav) parts.push('fav='+encodeURIComponent(fav)); if(done) parts.push('done='+encodeURIComponent(done)); if(name) parts.push('sharer='+encodeURIComponent(name)); parts.push('auto=' + (autoOpenShared ? '1' : '0')); return base + (parts.length ? ('?'+parts.join('&')) : ''); }
function copyTextToClipboard(text){ if(navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(text).catch(()=> fallbackCopy(text)); } else fallbackCopy(text); function fallbackCopy(t){ const ta=document.createElement('textarea'); ta.value=t; ta.style.position='fixed'; ta.style.left='-9999px'; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); }catch(e){} document.body.removeChild(ta); } }

// share controls
$('copyShare').addEventListener('click',()=>{ copyTextToClipboard(genShareUrl()); alert('共有リンクをコピーしました'); });
$('openShare').addEventListener('click',()=>{ window.open(genShareUrl(),'_blank'); });
$('genText').addEventListener('click', ()=>{ const txt = buildShareText(); shareTextEl.value = txt; copyTextToClipboard(txt); alert('共有テキストを生成＆コピーしました'); });
$('genQr').addEventListener('click', ()=>{ const url = genShareUrl(); const qrUrl = 'https://chart.googleapis.com/chart?cht=qr&chs=300x300&chl=' + encodeURIComponent(url); qrImgEl.src = qrUrl; qrImgEl.style.display = 'block'; });

// build share text
function buildShareText(){ const earned=computeEarnedPoints(); const avail=computeAvailablePoints(); const favEvents = events.filter(e=>favIds.includes(e.id)); const doneEvents = events.filter(e=>doneIds.includes(e.id)); const lines=[]; const name = localStorage.getItem('my_name')||''; lines.push((name ? name + ' さんの ' : '私の ') + 'レトロこみちポイント（利用可能）： ' + avail + 'pt（獲得: ' + earned + 'pt）'); lines.push(''); if(doneEvents.length){ lines.push('行ったイベント:'); doneEvents.forEach(e=> lines.push(`・${e.title}（${e.start}）`)); lines.push(''); } if(favEvents.length){ lines.push('お気に入り:'); favEvents.forEach(e=> lines.push(`・${e.title}（${e.start}）`)); lines.push(''); } lines.push('お気に入りを開く：' + genShareUrl()); return lines.join('\n'); }

// points rendering & confetti
function renderPoints(){
  const earned = computeEarnedPoints();
  const spent = getSpentPoints();
  const avail = computeAvailablePoints();
  pointSummaryEl.textContent = `ポイント: ${avail}pt`;
  pointsText.textContent = `${avail} / ${POINT_GOAL} pt`;
  earnedText.textContent = `獲得: ${earned}pt ・ 消費: ${spent}pt`;
  doneCountEl.textContent = doneIds.length;
  const rank = earned >= 200 ? 'レトロこみち王' : earned >= 100 ? 'レトロマスター' : earned >= 50 ? '初級レトロウォーカー' : 'ビギナー';
  rankText.textContent = '称号: ' + rank;

  // donut
  const canvas = pointsCanvas; const ctx = canvas.getContext('2d'); const size = Math.min(canvas.width, canvas.height); const cx = canvas.width/2, cy = canvas.height/2, r = size/2 - 6;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fillStyle = '#f3fbff'; ctx.fill();
  const ratio = Math.min(1, Math.max(0, avail / POINT_GOAL)); const start = -Math.PI/2; const end = start + ratio * Math.PI*2;
  ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,start,end); ctx.closePath(); ctx.fillStyle = 'rgba(74,163,217,0.95)'; ctx.fill();
  ctx.beginPath(); ctx.arc(cx,cy,r*0.62,0,Math.PI*2); ctx.fillStyle = '#ffffff'; ctx.fill();
  ctx.fillStyle = '#24303a'; ctx.font = '700 14px system-ui,Segoe UI'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(Math.round(ratio*100) + '%', cx, cy-6); ctx.font = '600 11px system-ui'; ctx.fillText(avail + 'pt', cx, cy+14);

  try{
    const shown = localStorage.getItem('confetti_50_shown') === '1';
    if(avail >= 50 && !shown){ launchConfetti(); localStorage.setItem('confetti_50_shown','1'); }
    else if(avail < 50 && shown){ localStorage.removeItem('confetti_50_shown'); }
  }catch(e){ console.warn(e); }

  if(!previewMode && avail >= EXCHANGE_COST) btnExchange.removeAttribute('disabled'); else btnExchange.setAttribute('disabled','disabled');
  availText.textContent = `残高: ${avail}pt`;
}

function launchConfetti(){ const confettiEl = $('confetti'); if(!confettiEl) return; confettiEl.style.display='block'; const colors = ['#ff6b6b','#ffd166','#4aa3d9','#7ad7b8','#9b72d1','#ff9aa2']; const pieces=100; for(let i=0;i<pieces;i++){ const el=document.createElement('div'); el.className='confetti-piece'; const s=Math.floor(6+Math.random()*10); el.style.width=s+'px'; el.style.height=Math.floor(s*1.4)+'px'; el.style.background = colors[Math.floor(Math.random()*colors.length)]; el.style.left = Math.random()*100 + '%'; el.style.top = (-Math.random()*10) + 'vh'; el.style.transform = `rotate(${Math.floor(Math.random()*360)}deg)`; const delay = Math.random()*0.6; const dur = 2.5 + Math.random()*1.5; el.style.animation = `confetti-fall ${dur}s ${delay}s cubic-bezier(.2,.6,.2,1) forwards`; confettiEl.appendChild(el); } setTimeout(()=>{ confettiEl.innerHTML=''; confettiEl.style.display='none'; },4500); }

// redemption & admin render
function renderRedemptions(){ const list = getRedemptions(); redemptionListEl.innerHTML = (!list.length) ? '<div class="small muted">利用履歴はありません</div>' : list.slice().reverse().map(r=>`<div class="small">${new Date(r.date).toLocaleString()} — ${r.title} (${r.cost}pt)</div>`).join(''); }
function renderAdminAdjustments(){ const list = getAdminAdjustments(); adminListEl.innerHTML = (!list.length) ? '<div class="small muted">付与履歴はありません</div>' : list.slice().reverse().map(a=>`<div class="small">${new Date(a.date).toLocaleString()} — ${a.note||'管理操作'}： ${Number(a.amount)>=0?'+':''}${a.amount}pt</div>`).join(''); }

// --- Exchange modal (full) ---
btnExchange.addEventListener('click', ()=> { if(previewMode) return alert('プレビュー中は交換できません'); openExchangeModal(); });

function openExchangeModal(){
  const earned = computeEarnedPoints();
  const spent = getSpentPoints();
  const avail = computeAvailablePoints();
  const html = `
    <div class="modal-backdrop">
      <div class="modal">
        <h2>景品交換</h2>
        <div style="display:flex;gap:12px;align-items:center">
          <div style="width:120px;height:120px;display:flex;align-items:center;justify-content:center">
            <canvas id="exchangeChart" width="120" height="120"></canvas>
          </div>
          <div style="flex:1">
            <div style="font-size:1.1rem;font-weight:700">${avail} pt（利用可能）</div>
            <div class="small muted">獲得: ${earned}pt ・ 消費: ${spent}pt</div>
            <div style="margin-top:10px" class="small muted">交換可能: ${avail >= EXCHANGE_COST ? '可能' : '残高不足'}</div>
          </div>
        </div>

        <div style="margin-top:14px">
          <div class="small muted">交換アイテム</div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;border:1px solid #eef4f9;margin-top:8px">
            <div>
              <strong>限定ステッカーセット</strong>
              <div class="small muted">イベント限定デザインのステッカー</div>
            </div>
            <div style="text-align:right">
              <div class="small muted">${EXCHANGE_COST} pt</div>
              <button id="proceedExchange" class="btn-primary" ${avail >= EXCHANGE_COST ? '' : 'disabled'}>交換へ進む</button>
            </div>
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="closeExchange" style="margin-left:auto">閉じる</button>
        </div>
      </div>
    </div>
  `;
  $('exchangeModal').innerHTML = html;
  $('exchangeModal').style.display = 'block';

  // draw chart inside modal
  const exCanvas = document.getElementById('exchangeChart');
  if(exCanvas){
    const ctx = exCanvas.getContext('2d');
    const size = Math.min(exCanvas.width, exCanvas.height);
    const cx = exCanvas.width/2, cy = exCanvas.height/2, r = size/2 - 6;
    ctx.clearRect(0,0,exCanvas.width,exCanvas.height);
    ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fillStyle='#f3fbff'; ctx.fill();
    const ratio = Math.min(1, Math.max(0, computeAvailablePoints()/POINT_GOAL));
    const start = -Math.PI/2;
    const end = start + ratio * Math.PI*2;
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,start,end); ctx.closePath(); ctx.fillStyle='rgba(74,163,217,0.95)'; ctx.fill();
    ctx.beginPath(); ctx.arc(cx,cy,r*0.62,0,Math.PI*2); ctx.fillStyle='#fff'; ctx.fill();
    ctx.fillStyle='#24303a'; ctx.font='700 12px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(Math.round(ratio*100) + '%', cx, cy-6); ctx.font='600 11px system-ui';
    ctx.fillText(computeAvailablePoints() + 'pt', cx, cy+14);
  }

  $('closeExchange').addEventListener('click', ()=> { $('exchangeModal').style.display='none'; });
  const proceed = document.getElementById('proceedExchange');
  proceed && proceed.addEventListener('click', ()=> showStaffCodeEntry());
}

function showStaffCodeEntry(){
  const html = `
    <div class="modal-backdrop">
      <div class="modal">
        <h2>関係者確認</h2>
        <div class="small muted">関係者の方は下のコードを入力し、「確認」してください。</div>
        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <input id="staffCodeInput" class="input" placeholder="関係者コードを入力" style="flex:1"/>
          <button id="confirmStaffCode" class="btn-primary">確認</button>
        </div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="cancelStaffCode" style="margin-left:auto">キャンセル</button>
        </div>
      </div>
    </div>
  `;
  $('exchangeModal').innerHTML = html;
  $('exchangeModal').style.display = 'block';
  $('cancelStaffCode').addEventListener('click', ()=> { $('exchangeModal').style.display='none'; });

  $('confirmStaffCode').addEventListener('click', ()=> {
    const code = $('staffCodeInput').value.trim();
    if(code === STAFF_CODE){
      const item = { id: 'ex1', title: '限定ステッカーセット', cost: EXCHANGE_COST, date: new Date().toISOString() };
      addRedemption(item);
      $('exchangeModal').innerHTML = `
        <div class="modal-backdrop">
          <div class="modal">
            <h2>交換完了</h2>
            <div class="success-note">ポイントを消費しました。<br> ${item.title} を ${item.cost}pt 消費しました。</div>
            <div style="display:flex;gap:8px;margin-top:12px">
              <button id="closeSuccess" class="btn-primary">閉じる</button>
            </div>
          </div>
        </div>`;
      $('closeSuccess').addEventListener('click', ()=>{
        $('exchangeModal').style.display = 'none';
        renderAll();
      });
    } else {
      alert('関係者コードが正しくありません');
    }
  });
}

// --- Staff panel & claim-link generation ---
staffBtn.addEventListener('click', ()=> openStaffAuthModal());

function openStaffAuthModal(){
  const html = `
    <div class="modal-backdrop">
      <div class="modal">
        <h3>関係者ログイン</h3>
        <div class="small muted">管理者コードを入力してください。</div>
        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <input id="staffAuthInput" class="input" placeholder="関係者コード" style="flex:1"/>
          <button id="staffAuthBtn" class="btn-primary">ログイン</button>
        </div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="staffAuthCancel" style="margin-left:auto">閉じる</button>
        </div>
      </div>
    </div>
  `;
  modalEl.innerHTML = html; modalEl.style.display = 'block';
  $('staffAuthCancel').addEventListener('click', ()=> { modalEl.style.display='none'; });
  $('staffAuthBtn').addEventListener('click', ()=> {
    const code = $('staffAuthInput').value.trim();
    if(code === STAFF_CODE){ modalEl.style.display = 'none'; openStaffPanel(); } else { alert('関係者コードが正しくありません'); }
  });
}

function openStaffPanel(){
  const earned = computeEarnedPoints();
  const spent = getSpentPoints();
  const avail = computeAvailablePoints();
  const html = `
    <div class="modal-backdrop">
      <div class="modal">
        <h2>スタッフパネル</h2>
        <div class="small muted">現在のポイント： 利用可能 ${avail}pt（獲得 ${earned}pt / 消費 ${spent}pt）</div>

        <hr style="margin:10px 0">

        <div><strong>ポイントを付与する（既存）</strong></div>
        <div class="staff-panel-row">
          <input id="adminGrantAmount" type="number" min="1" placeholder="付与ポイント" class="input"/>
          <input id="adminGrantNote" placeholder="備考（例: 受付ボーナス）" class="input" />
          <button id="adminGrantBtn" class="btn-primary">付与する</button>
        </div>
        <div class="staff-panel-note">付与は即時アカウントに反映されます。</div>

        <hr style="margin:10px 0">

        <div><strong>ポイントを消費（管理で登録）</strong></div>
        <div class="staff-panel-row">
          <input id="adminSpendAmount" type="number" min="1" placeholder="消費ポイント" class="input"/>
          <input id="adminSpendNote" placeholder="備考（例: 交換手配）" class="input" />
          <button id="adminSpendBtn" class="btn-primary">消費登録</button>
        </div>
        <div class="staff-panel-note">消費登録は redemptions に追加され、利用可能ポイントが減ります。</div>

        <hr style="margin:10px 0">

        <div><strong>付与/消費リンクを生成（QR化して配布可）</strong></div>
        <div class="staff-panel-row">
          <select id="claimTypeSelect" class="input">
            <option value="grant">付与（受け取る側に加算）</option>
            <option value="spend">消費（受け取る側の残高から差し引く）</option>
          </select>
          <input id="claimAmount" type="number" min="1" class="input" placeholder="ポイント数" />
        </div>
        <div class="staff-panel-row">
          <select id="claimEventSelect" class="input"><option value="">イベント紐づけなし（任意）</option>${events.map(e=>`<option value="${e.id}">${e.title}</option>`).join('')}</select>
          <input id="claimNote" class="input" placeholder="備考（例: 受付ボーナス）" />
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="generateClaimLink" class="btn-primary">リンクを生成</button>
          <button id="closeStaffPanel" style="margin-left:auto">閉じる</button>
        </div>

        <div id="claimLinkArea" style="margin-top:12px"></div>

      </div>
    </div>
  `;
  modalEl.innerHTML = html; modalEl.style.display = 'block';

  $('closeStaffPanel').addEventListener('click', ()=> { modalEl.style.display='none'; renderAll(); });

  $('adminGrantBtn').addEventListener('click', ()=> {
    const amt = Number($('adminGrantAmount').value) || 0; const note = $('adminGrantNote').value.trim() || '管理付与';
    if(amt<=0){ alert('付与ポイントは1以上で入力してください'); return; }
    if(!confirm(`${amt}pt を付与しますか？\n備考: ${note}`)) return;
    const rec = { id:'g'+Date.now(), amount: amt, note: note, date: new Date().toISOString() };
    addAdminAdjustment(rec);
    alert(`${amt}pt を付与しました`); modalEl.style.display='none'; renderAll();
  });

  $('adminSpendBtn').addEventListener('click', ()=> {
    const amt = Number($('adminSpendAmount').value) || 0; const note = $('adminSpendNote').value.trim() || '管理消費';
    if(amt<=0){ alert('消費ポイントは1以上で入力してください'); return; }
    if(computeAvailablePoints()<amt){ alert('残高が不足しています'); return; }
    if(!confirm(`${amt}pt を消費登録しますか？\n備考: ${note}`)) return;
    const rec = { id:'s'+Date.now(), title: note, cost: amt, date: new Date().toISOString() };
    addRedemption(rec); alert(`${amt}pt を消費登録しました`); modalEl.style.display='none'; renderAll();
  });

  $('generateClaimLink').addEventListener('click', ()=>{
    const type = $('claimTypeSelect').value;
    const amount = Number($('claimAmount').value) || 0;
    const eventId = $('claimEventSelect').value;
    const note = $('claimNote').value.trim();
    if(amount <= 0){ alert('ポイント数を1以上で入力してください'); return; }
    const token = 'cl' + Date.now() + Math.floor(Math.random()*1000);
    const base = location.origin + location.pathname;
    const parts = [`claim_type=${encodeURIComponent(type)}`, `amount=${encodeURIComponent(amount)}`, `token=${encodeURIComponent(token)}`];
    if(eventId) parts.push(`event=${encodeURIComponent(eventId)}`);
    if(note) parts.push(`note=${encodeURIComponent(note)}`);
    const link = base + '?' + parts.join('&');
    const qr = 'https://chart.googleapis.com/chart?cht=qr&chs=300x300&chl=' + encodeURIComponent(link);
    const area = $('claimLinkArea');
    area.innerHTML = `<div class="small muted">生成リンク（配布用）</div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
        <input class="input" id="claimLinkInput" style="flex:1" readonly value="${link}" />
        <button id="copyClaimLink" class="btn-primary">コピー</button>
      </div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <img src="${qr}" style="width:86px;height:86px;border-radius:6px;border:1px solid #eee" alt="QR"/>
        <div class="small muted">右のQRを印刷して掲示できます。</div>
      </div>`;
    $('copyClaimLink').addEventListener('click', ()=> { copyTextToClipboard(link); alert('リンクをコピーしました'); });
  });
}

// --- Claim link processing on page open ---
function showClaimModal(params){
  const type = params.get('claim_type');
  const amount = Number(params.get('amount')||0);
  const token = params.get('token') || ('cl' + Date.now());
  const eventId = params.get('event');
  const note = params.get('note') ? decodeURIComponent(params.get('note')) : '';
  if(!type || !amount) return;
  const ev = eventId ? events.find(e=>e.id===Number(eventId)) : null;
  const usedKey = 'claim_used_' + token;
  const alreadyUsed = !!localStorage.getItem(usedKey);
  const html = `
    <div class="modal-backdrop">
      <div class="modal">
        <h2>リンクでのポイント処理</h2>
        <div class="small muted">${ev ? ev.title : 'イベント未指定'} ${ note ? '／' + note : '' }</div>
        <div style="margin-top:10px">
          <div class="small muted">操作: ${type === 'grant' ? 'ポイント付与' : 'ポイント消費'}</div>
          <div style="font-size:1.4rem;font-weight:700;margin-top:6px">${amount} pt</div>
          <div class="small muted" style="margin-top:6px">${ alreadyUsed ? 'このリンクはこの端末で既に使用されています。' : '' }</div>
        </div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="claimDoBtn" class="btn-primary" ${ alreadyUsed ? 'disabled' : '' }>${ type === 'grant' ? 'ポイントを受け取る' : '消費を実行' }</button>
          <button id="claimCancel" style="margin-left:auto">閉じる</button>
        </div>
      </div>
    </div>
  `;
  modalEl.innerHTML = html; modalEl.style.display = 'block';

  $('claimCancel').addEventListener('click', ()=> { modalEl.style.display='none'; history.replaceState(null,'', location.pathname); });

  $('claimDoBtn').addEventListener('click', ()=> {
    if(localStorage.getItem(usedKey)){ alert('このリンクは既に使用されています（この端末）。'); return; }
    if(type === 'grant'){
      const rec = { id:'clg'+Date.now(), amount: amount, note: note || 'リンク付与', date: new Date().toISOString() };
      addAdminAdjustment(rec);
      localStorage.setItem(usedKey, new Date().toISOString());
      alert(`${amount}pt を付与しました`);
      modalEl.style.display='none';
      history.replaceState(null,'', location.pathname);
      renderAll();
    } else if(type === 'spend'){
      if(computeAvailablePoints() < amount){ alert('利用可能ポイントが不足しています'); return; }
      const rec = { id:'cls'+Date.now(), title: note || 'リンク消費', cost: amount, date: new Date().toISOString() };
      addRedemption(rec);
      localStorage.setItem(usedKey, new Date().toISOString());
      alert(`${amount}pt を消費しました`);
      modalEl.style.display='none';
      history.replaceState(null,'', location.pathname);
      renderAll();
    } else {
      alert('不明な操作です');
    }
  });
}

// --- Share accept / preview ---
function showShareAcceptDialog(sharer, favList, doneList){
  const modalHtml = `
    <div class="modal-backdrop">
      <div class="modal">
        <h3>${sharer} さんから共有リンクを受け取りました</h3>
        <p class="small muted">以下のお気に入りを一時的にプレビューできます。あなたのローカルデータは変更されません。プレビューを受け入れると共有者のお気に入り一覧を確認できます。必要なら後で自分のお気に入りに取り込みできます。</p>
        <div style="margin-top:8px;max-height:220px;overflow:auto;border:1px solid #f0f4f8;padding:8px;border-radius:8px;">
          ${ (favList.length ? favList.map(id=>{ const ev = events.find(e=>e.id===id); return `<div style="margin-bottom:6px"><strong>${ev?ev.title:'(不明なイベント)'} </strong><div class="small muted">${ev?ev.start+' ・ '+ev.place:''}</div></div>`; }).join('') : '<div class="muted small">共有されたお気に入りはありません</div>') }
        </div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="acceptSharedBtn" class="btn-primary">プレビューを開く</button>
          <button id="importSharedBtn">自分のお気に入りに取り込む</button>
          <button id="declineSharedBtn" style="margin-left:auto">閉じる</button>
        </div>
      </div>
    </div>
  `;
  modalEl.innerHTML = modalHtml; modalEl.style.display = 'block';

  $('acceptSharedBtn').addEventListener('click', ()=>{
    previewMode = true; previewFavIds = favList.slice(); previewDoneIds = doneList.slice(); previewSharer = sharer;
    modalEl.style.display = 'none'; renderAll(); showPreviewBanner();
  });
  $('importSharedBtn').addEventListener('click', ()=>{
    const mergedFav = Array.from(new Set([...(favIds||[]), ...favList]));
    const mergedDone = Array.from(new Set([...(doneIds||[]), ...doneList]));
    favIds = mergedFav; doneIds = mergedDone;
    setLocalArr('fav_ids',favIds); setLocalArr('done_ids',doneIds);
    modalEl.style.display = 'none'; previewMode = false; previewFavIds = []; previewDoneIds = [];
    alert('共有されたお気に入りをあなたのマイページに取り込みました'); renderAll();
  });
  $('declineSharedBtn').addEventListener('click', ()=> { modalEl.style.display = 'none'; });
}

function showPreviewBanner(){
  const parentCard = favListEl.parentElement;
  let banner = parentCard.querySelector('.preview-banner');
  if(!banner){ banner = document.createElement('div'); banner.className = 'preview-banner'; parentCard.insertBefore(banner, favListEl); }
  banner.innerHTML = `<strong>プレビュー中：</strong> ${previewSharer || '共有者'} さんの共有お気に入り。<span class="small muted">（あなたのローカルは変更されていません）</span>
    <div style="margin-top:8px;display:flex;gap:8px">
      <button id="importFromPreview" class="btn-primary">自分のお気に入りに取り込む</button>
      <button id="exitPreview" style="margin-left:auto">プレビューを閉じる</button>
    </div>`;
  parentCard.scrollIntoView({behavior:'smooth'});
  $('importFromPreview').addEventListener('click', ()=>{ const merged = Array.from(new Set([...(favIds||[]), ...previewFavIds])); favIds = merged; setLocalArr('fav_ids',favIds); previewMode = false; previewFavIds = []; alert('プレビューのお気に入りをあなたのマイページに取り込みました'); renderAll(); });
  $('exitPreview').addEventListener('click', ()=>{ previewMode = false; previewFavIds = []; if(banner) banner.remove(); renderAll(); });
}

// --- Claim / QR handling on load ---
(function(){
  const params = new URLSearchParams(location.search);
  const favParam = params.get('fav');
  const doneParam = params.get('done');
  const sharer = params.get('sharer');
  const auto = params.get('auto');
  if(auto==='0') autoOpenShared = false;
  $('autoOpenShared').checked = autoOpenShared;

  if(sharer && (favParam || doneParam)){
    const favList = favParam ? favParam.split(',').map(s=>Number(s)).filter(Boolean) : [];
    const doneList = doneParam ? doneParam.split(',').map(s=>Number(s)).filter(Boolean) : [];
    setTimeout(()=> showShareAcceptDialog(sharer, favList, doneList), 300);
    return;
  }

  if(params.get('claim_type')){
    setTimeout(()=> showClaimModal(params), 300);
    return;
  }

  const qrParam = params.get('qr');
  if(qrParam){
    setTimeout(()=> showQrClaimModal(qrParam), 300);
    return;
  }

  const evId = Number(params.get('ev'));
  if(evId && autoOpenShared){
    const ev = events.find(x=>x.id===evId);
    if(ev) setTimeout(()=> openSheet(ev), 300);
  }
})();

// --- QR check-in (compat) ---
function getQrClaimKey(id){ return 'qr_claimed_' + id; }
function showQrClaimModal(eventId){
  const id = Number(eventId); const ev = events.find(e=>e.id===id);
  if(!ev){ alert('不明なイベントのQRです'); return; }
  if(localStorage.getItem(getQrClaimKey(id))){ qrScannerModalEl.innerHTML = `<div class="modal-backdrop"><div class="modal"><h2>QR確認</h2><div class="small muted">${ev.title} の来場ポイントは既に受け取られています。</div><div style="display:flex;gap:8px;margin-top:12px"><button id="closeQrOk" class="btn-primary">閉じる</button></div></div></div>`; qrScannerModalEl.style.display='block'; $('closeQrOk').addEventListener('click', ()=> { qrScannerModalEl.style.display='none'; }); return; }
  const html = `<div class="modal-backdrop"><div class="modal"><h2>来場ポイント受け取り</h2><div class="small muted">QRコード: ${ev.title}</div><div style="display:flex;gap:12px;align-items:center;margin-top:10px"><div style="width:120px;height:120px;display:flex;align-items:center;justify-content:center;border-radius:8px;background:#f8fbff"><img src="${ev.image||''}" style="max-width:100%;max-height:100%;border-radius:6px" /></div><div style="flex:1"><div style="font-weight:700;margin-bottom:6px">${ev.title}</div><div class="small muted">日時: ${ev.start} - ${ev.end} ・ ${ev.place}</div><div style="margin-top:8px" class="small muted">このイベントに来場したことを確認すると、${POINT_PER_EVENT}pt を受け取れます。</div></div></div><div style="display:flex;gap:8px;margin-top:14px"><button id="claimQrBtn" class="btn-primary">ポイントを受け取る</button><button id="cancelQrBtn" style="margin-left:auto">閉じる</button></div></div></div>`;
  qrScannerModalEl.innerHTML = html; qrScannerModalEl.style.display='block';
  $('cancelQrBtn').addEventListener('click', ()=> { qrScannerModalEl.style.display='none'; });
  $('claimQrBtn').addEventListener('click', ()=> { if(!doneIds.includes(id)) doneIds.push(id); setLocalArr('done_ids',doneIds); localStorage.setItem(getQrClaimKey(id),'1'); addRedemption({ id:'qr'+Date.now(), title:`QR:${ev.title}`, cost:0, date:new Date().toISOString() }); alert(`${POINT_PER_EVENT}pt を付与しました（行ったイベントとして記録）`); qrScannerModalEl.style.display='none'; renderAll(); });
}

// --- QR scanner (optional) ---
let qrStream = null; let qrDetectorActive = false;
async function openQrScanner(){
  const html = `<div class="modal-backdrop"><div class="modal qr-scanner"><h2>QRコードを読み取る</h2><div class="qr-video" id="qrVideoWrap"><video id="qrVideo" autoplay muted playsinline></video></div><div class="qr-result" id="qrResult"></div><div class="qr-manual"><input id="qrManualInput" class="input" placeholder="読み取りできない場合、ここにQRのリンクを貼ってください" /><button id="qrManualOpen" class="btn-primary">開く</button></div><div style="display:flex;gap:8px;margin-top:8px"><button id="closeQrScanner" style="margin-left:auto">閉じる</button></div></div></div>`;
  qrScannerModalEl.innerHTML = html; qrScannerModalEl.style.display='block';
  const video = document.getElementById('qrVideo'); const resultEl = document.getElementById('qrResult');
  const hasBarcodeDetector = ('BarcodeDetector' in window);
  try{ qrStream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false }); video.srcObject = qrStream; video.play(); }catch(e){ resultEl.textContent = 'カメラの起動に失敗しました。手動でリンクを貼ってください。'; return; }
  let detector = null; if(hasBarcodeDetector){ try{ detector = new BarcodeDetector({ formats:['qr_code'] }); }catch(e){ detector=null; } }
  qrDetectorActive = true; let stop=false;
  async function scanFrame(){ if(!qrDetectorActive || stop) return; try{ if(detector){ const barcodes = await detector.detect(video); if(barcodes && barcodes.length){ const barcode = barcodes[0]; const text = barcode.rawValue || barcode.displayValue; if(text){ onQrScanned(text); stop=true; return; } } } }catch(e){} requestAnimationFrame(scanFrame); }
  requestAnimationFrame(scanFrame);
  document.getElementById('qrManualOpen').addEventListener('click', ()=>{ const val=document.getElementById('qrManualInput').value.trim(); if(val) onQrScanned(val); });
  document.getElementById('closeQrScanner').addEventListener('click', ()=>{ qrDetectorActive=false; stopCamera(); qrScannerModalEl.style.display='none'; });
  function onQrScanned(text){ qrDetectorActive=false; stopCamera(); resultEl.textContent = '読み取り: ' + text; try{ const url = new URL(text, location.href); if(url.pathname === location.pathname && (url.searchParams.has('qr') || url.searchParams.has('claim_type'))){ location.href = url.href; return; } else { window.open(url.href, '_blank'); qrScannerModalEl.style.display='none'; return; } }catch(e){ alert('無効なリンクです: ' + text); qrScannerModalEl.style.display='none'; } }
}
function stopCamera(){ if(qrStream){ qrStream.getTracks().forEach(t=>t.stop()); qrStream=null; } }
$('btnScanQr').addEventListener('click', ()=> openQrScanner());

// name & bulk actions
$('saveNameBtn').addEventListener('click', ()=>{ const v = $('myNameInput').value.trim(); myName=v; if(myName) localStorage.setItem('my_name', myName); else localStorage.removeItem('my_name'); updateNameUI(); shareUrlEl.value = genShareUrl(); alert('表示名を保存しました'); });
$('clearNameBtn').addEventListener('click', ()=>{ if(!confirm('表示名をクリアしますか？')) return; myName=''; localStorage.removeItem('my_name'); updateNameUI(); shareUrlEl.value = genShareUrl(); });
$('btnUnfav').addEventListener('click', ()=>{ if(!confirm('本当にすべてのお気に入りを解除しますか？')) return; favIds=[]; setLocalArr('fav_ids',favIds); renderAll(); });
$('btnResetAll').addEventListener('click', ()=>{ if(!confirm('ローカルデータ（お気に入り・行った・メモ 等）をすべて消去しますか？戻せません。')) return; localStorage.clear(); favIds=[]; doneIds=[]; myName=''; updateNameUI(); renderAll(); });
$('btnClearFavs').addEventListener('click', ()=>{ if(!confirm('お気に入りだけをリセットします。よろしいですか？')) return; favIds=[]; setLocalArr('fav_ids',favIds); renderAll(); });
$('btnClearMemo').addEventListener('click', ()=>{ if(!confirm('メモをすべて削除します。よろしいですか？')) return; for(const k in localStorage) if(k.startsWith('memo_')) localStorage.removeItem(k); renderAll(); });

// auto open shared persist
$('autoOpenShared').checked = autoOpenShared;
$('autoOpenShared').addEventListener('change', (e)=> { autoOpenShared = !!e.target.checked; localStorage.setItem('auto_open_shared', autoOpenShared ? '1' : '0'); });

// initial share url and render
shareUrlEl.value = genShareUrl();
window.addEventListener('DOMContentLoaded', ()=> { renderAll(); });

// expose internals for debug
window._mp = { events, favIds, doneIds, getRedemptions, getAdminAdjustments };

/*
  Notes:
  - Claim links are purely client-side: to prevent cross-device reuse, add server-side verification.
  - To generate printable QR codes from links, use:
    https://chart.googleapis.com/chart?cht=qr&chs=300x300&chl=<ENCODED_LINK>
*/
</script>
</body>
</html>
